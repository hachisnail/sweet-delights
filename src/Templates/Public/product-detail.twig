{% extends "Layouts/public.twig" %}

{% block content %}
<div class="max-w-4xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow-lg border border-pink-100"
     data-product-id="{{ product.id }}"
     data-product-name="{{ product.name }}"
     data-product-price="{{ product.price }}"
     data-product-image="{{ product.image }}"
     data-product-stock="{{ product.stock }}"
     data-product-sizes='{{ product.sizes|json_encode|raw }}'>

  <div class="flex flex-col md:flex-row gap-8">
    <div class="md:w-1/2 flex justify-center">
      <img src="{{ product.image }}" alt="{{ product.name }}"
           class="rounded-xl w-full max-w-sm object-cover shadow-md shadow-pink-100">
    </div>

    <div class="md:w-1/2 flex flex-col justify-between">
      <div>
        <h1 class="text-3xl font-bold text-[#835234] mb-2">{{ product.name }}</h1>
        <p class="text-sm text-pink-600 font-semibold mb-2">{{ product.category }}</p>
        <p class="text-gray-600 mb-4 text-lg">₱{{ product.price }}</p>
        <p class="text-gray-700 mb-6 leading-relaxed">{{ product.description }}</p>

        {% if product.sizes is defined and product.sizes|length > 0 %}
          <div class="mb-4">
            <p class="font-semibold text-[#835234] mb-1">Available Sizes:</p>
            <div id="sizeSelector" class="flex gap-2 flex-wrap">
              {% for size in product.sizes %}
                <button 
                  type="button"
                  data-size="{{ size.name }}"
                  data-stock="{{ size.stock }}"
                  class="size-btn px-3 py-1 bg-pink-100 text-pink-700 rounded-lg text-sm hover:bg-pink-200 focus:outline-none transition">
                  {{ size.name }} ({{ size.stock }})
                </button>
              {% endfor %}
            </div>
            <div id="sizeWarning" class="hidden flex items-center gap-2 mt-1 text-red-500 text-xs">
              <svg xmlns="http://www.w3.org/2000/svg" 
                   width="16" height="16" viewBox="0 0 24 24" fill="none" 
                   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                   class="lucide lucide-triangle-alert flex-shrink-0">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/>
                <path d="M12 9v4"/>
                <path d="M12 17h.01"/>
              </svg>
              <p>Please select a size before adding to cart.</p>
            </div>

          </div>
        {% endif %}

        <p class="text-sm text-gray-500 mt-4">Total Stock: {{ product.stock }}</p>
      </div>

      <div class="mt-6 flex flex-col gap-3">
        <div class="flex items-center gap-3">
          <label class="text-[#835234] font-semibold">Quantity:</label>
          <div class="flex items-center border rounded-lg overflow-hidden">
            <button id="decreaseQty" class="px-3 py-1 bg-pink-100 hover:bg-pink-200">−</button>
            <input id="quantityInput" type="number" value="1" min="1" max="{{ product.stock }}"
                   class="w-16 text-center border-l border-r outline-none">
            <button id="increaseQty" class="px-3 py-1 bg-pink-100 hover:bg-pink-200">+</button>
          </div>
        </div>

        <div class="flex gap-3">
          <button id="addToCartBtn" 
                  class="flex-1 bg-[#835234] hover:bg-[#6d412a] text-white py-2 rounded-xl transition">
            Add to Cart
          </button>
          <button id="addToFavouriteBtn" 
                  class="bg-pink-100 hover:bg-pink-200 text-[#835234] p-2 rounded-xl transition relative">
            <svg id="heartIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
                 stroke-linecap="round" stroke-linejoin="round" 
                 class="lucide lucide-heart transition-all duration-300">
              <path d="M19.5 12.571 12 20l-7.5-7.429A5 5 0 0 1 12 6a5 5 0 0 1 7.5 6.571Z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Simple shake animation for size warning */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}
.shake {
  animation: shake 0.3s ease-in-out;
}
</style>

<script>
// ✅ LISTEN FOR THE NEW "servicesReady" EVENT
window.addEventListener("servicesReady", () => {
  const container = document.querySelector("[data-product-id]");
  if (!container) return;

  // --- Get all elements (no change) ---
  const qtyInput = document.getElementById("quantityInput");
  const decBtn = document.getElementById("decreaseQty");
  const incBtn = document.getElementById("increaseQty");
  const sizeButtons = Array.from(document.querySelectorAll("[data-size]"));
  const sizeWarning = document.getElementById("sizeWarning");
  const sizeSelector = document.getElementById("sizeSelector");
  const addToCartBtn = document.getElementById("addToCartBtn");
  const addToFavouriteBtn = document.getElementById("addToFavouriteBtn");
  const heartIcon = document.getElementById("heartIcon");

  // --- Product data (no change) ---
  const product = {
    id: Number(container.dataset.productId),
    name: container.dataset.productName,
    price: Number(container.dataset.productPrice),
    image: container.dataset.productImage,
    stock: Number(container.dataset.productStock || "1"), // Used for products WITHOUT sizes
    sizes: JSON.parse(container.dataset.productSizes || "[]"),
  };

  let selectedSize = null;
  let selectedStock = 0;

  // --- Heart UI (Refactored) ---
  const updateHeartUI = () => {
    // ✅ This will now work
    const inFav = window.favouriteService.isFavourite(product.id); 
    if (inFav) {
      heartIcon.classList.add("fill-current", "text-pink-600");
    } else {
      heartIcon.classList.remove("fill-current", "text-pink-600");
    }
  };

  // --- Helpers (Refactored) ---
  const getAvailableStockForSelectedSize = () => {
    if (product.sizes.length > 0 && !selectedSize) return 0; // No size selected

    // Determine base stock (either from selected size or whole product)
    const baseStock = (selectedSize)
        ? selectedStock // This was set when clicking the size
        : product.stock; // Stock for products with no sizes
    
    // ✅ Use the service
    const cart = window.cartService.getCart(); 
    
    const existing = cart.find(
      p => Number(p.id) === product.id && (p.selectedSize ?? null) === (selectedSize ?? null)
    );
    const existingQty = existing ? Number(existing.quantity || 0) : 0;
    
    return Math.max(0, baseStock - existingQty);
  };

  const refreshQuantityUI = () => {
    // Logic for products with sizes
    if (product.sizes.length > 0) {
        if (!selectedSize) {
            addToCartBtn.classList.add("opacity-60", "cursor-not-allowed");
            addToCartBtn.dataset.disabled = "true";
            qtyInput.value = 1;
            decBtn.disabled = true;
            incBtn.disabled = true;
            return;
        }
    }
    
    // This logic now works for BOTH products with/without sizes
    const available = getAvailableStockForSelectedSize();

    addToCartBtn.classList.remove("opacity-60", "cursor-not-allowed");
    addToCartBtn.dataset.disabled = "false";
    
    if (available <= 0) {
      addToCartBtn.classList.add("opacity-60", "cursor-not-allowed");
      addToCartBtn.dataset.disabled = "true";
      addToCartBtn.textContent = "Out of Stock";
    } else {
      addToCartBtn.classList.remove("opacity-60", "cursor-not-allowed");
      addToCartBtn.dataset.disabled = "false";
      addToCartBtn.textContent = "Add to Cart";
    }

    decBtn.disabled = Number(qtyInput.value) <= 1;
    incBtn.disabled = Number(qtyInput.value) >= available;
    qtyInput.max = available; // Set max on input
  };

  // --- Size selection (Refactored) ---
  sizeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      // (Deselect logic)
      sizeButtons.forEach(b => b.classList.remove("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]"));
      sizeButtons.forEach(b => b.classList.add("bg-pink-100", "text-pink-700"));

      // (Select logic)
      btn.classList.remove("bg-pink-100", "text-pink-700");
      btn.classList.add("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]");

      selectedSize = btn.dataset.size;
      selectedStock = Number(btn.dataset.stock); // This is the TOTAL stock for this size
      
      sizeWarning.classList.add("hidden");
      qtyInput.value = 1; // Reset qty on size change
      refreshQuantityUI();
    });
  });

  // --- Auto-select single size (no change) ---
  if (product.sizes.length === 1) {
    const onlySizeBtn = sizeButtons[0];
    onlySizeBtn.click();
  }
  
  // --- Quantity buttons (Refactored) ---
  decBtn.addEventListener("click", () => {
    qtyInput.value = Math.max(1, Number(qtyInput.value) - 1);
    refreshQuantityUI();
  });

  incBtn.addEventListener("click", () => {
    const available = getAvailableStockForSelectedSize();
    qtyInput.value = Math.min(Number(qtyInput.value) + 1, available);
    refreshQuantityUI();
  });

  qtyInput.addEventListener("input", (e) => {
    const available = getAvailableStockForSelectedSize();
    if (Number(e.target.value) > available) {
        e.target.value = available;
    }
    if (Number(e.target.value) < 1) {
        e.target.value = 1;
    }
    refreshQuantityUI();
  });

  // --- Add to Cart (Refactored) ---
  addToCartBtn.addEventListener("click", () => {
    if (product.sizes.length > 0 && !selectedSize) {
      sizeWarning.classList.remove("hidden");
      sizeSelector.classList.add("shake");
      setTimeout(() => sizeSelector.classList.remove("shake"), 300);
      return;
    }

    const availableStock = getAvailableStockForSelectedSize();
    if (availableStock <= 0) {
      window.showModal({
        type: "warning",
        title: "Out of Stock",
        message: `Sorry, ${product.name}${selectedSize ? " (" + selectedSize + ")" : ""} is out of stock.`,
        buttons: [{ text: "OK", variant: "cancel" }],
      });
      return;
    }
    
    const requested = Math.min(Number(qtyInput.value) || 1, availableStock);

    // ✅ Use the service
    window.cartService.addItem({
        id: product.id,
        name: product.name,
        image: product.image,
        price: product.price,
        selectedSize,
        stock: selectedSize ? selectedStock : product.stock, // Pass the relevant TOTAL stock
    }, requested);

    window.showModal({
        type: "success",
        title: "Added to Cart",
        message: `${product.name}${selectedSize ? " (" + selectedSize + ")" : ""} × ${requested} added successfully.`,
        buttons: [{ text: "OK", variant: "confirm" }],
    });

    // Reset UI
    qtyInput.value = 1;
    if (product.sizes.length > 0) {
        selectedSize = null;
        selectedStock = 0;
        sizeButtons.forEach(b => {
          b.classList.remove("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]");
          b.classList.add("bg-pink-100", "text-pink-700");
        });
    }
    refreshQuantityUI();
  });


  // --- Favourites toggle (Refactored) ---
  addToFavouriteBtn.addEventListener("click", () => {
    // ✅ Use the service
    const wasAdded = window.favouriteService.toggle(product);
    
    // The service already updated the UI, but we can show a modal
    if (wasAdded) {
        window.showModal({
          type: "success",
          title: "Added to Favourites",
          message: `${product.name} has been added to your favourites.`,
          buttons: [{ text: "OK", variant: "confirm" }],
        });
    } else {
        window.showModal({
          type: "info",
          title: "Removed from Favourites",
          message: `${product.name} has been removed from your favourites.`,
          buttons: [{ text: "OK", variant: "cancel" }],
        });
    }
    // updateHeartUI(); // The service's event will trigger this
  });

  // --- Sync UI (Keep these listeners) ---
  // When the services fire events, update this page's UI
  window.addEventListener("favouritesChanged", updateHeartUI);
  window.addEventListener("cartChanged", refreshQuantityUI);
  
  // Also listen for storage events (other tabs)
  window.addEventListener("storage", () => {
    refreshQuantityUI();
    updateHeartUI();
  });

  // --- Initial Load ---
  refreshQuantityUI();
  updateHeartUI();
});
</script>
{% endblock %}