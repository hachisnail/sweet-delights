{% extends "Layouts/public.twig" %}

{% block content %}
<div class="snap-start pt-20 ">
<div class="max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-lg border border-pink-100 "
     data-product-id="{{ product.id }}"
     data-product-name="{{ product.name }}"
     data-product-price="{{ product.price }}" {# This is now the base/starting price #}
     data-product-image="{{ product.image }}"
     data-product-stock="{{ product.stock }}"
     data-product-sizes='{{ product.sizes|json_encode|raw }}'>

  <div class="flex flex-col md:flex-row gap-8">
    <div class="md:w-1/2 flex justify-center">
      <img src="{{ product.image }}" alt="{{ product.name }}"
           class="rounded-xl w-full max-w-sm object-cover shadow-md shadow-gray-400"
           onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';">
    </div>

    <div class="md:w-1/2 flex flex-col ">
      <div>
        <h1 class="text-3xl font-bold text-[#835234] mb-2">{{ product.name }}</h1>
        <p class="text-sm text-pink-600 font-semibold mb-2">{{ product.category_name }}</p>
        
        {# ✅ --- START PRICE REFACTOR --- #}
        <p id="productPriceDisplay" class="text-gray-600 mb-4 text-lg">
            {% if product.sizes is defined and product.sizes|length > 0 %}
                {# Show base price on load #}
                Starts at ₱{{ product.price|number_format(2, '.', ',') }}
            {% else %}
                {# Show regular price if no sizes #}
                ₱{{ product.price|number_format(2, '.', ',') }}
            {% endif %}
        </p>
        
        <p class="text-gray-700 mb-6 leading-relaxed">{{ product.description }}</p>

        {% if product.sizes is defined and product.sizes|length > 0 %}
          <div class="mb-4">
            <p class="font-semibold text-[#835234] mb-1">Available Sizes:</p>
            <div id="sizeSelector" class="flex gap-2 flex-wrap">
              {% for size in product.sizes %}
                <button 
                  type="button"
                  data-size="{{ size.name }}"
                  data-stock="{{ size.stock }}"
                  data-price="{{ size.price }}"
                  class="size-btn px-3 py-1 bg-pink-100 text-pink-700 rounded-lg text-sm hover:bg-pink-200 focus:outline-none transition">
                  {{ size.name }} (₱{{ size.price|number_format(2) }}) - {{ size.stock }} left
                </button>
              {% endfor %}
            </div>
            <div id="sizeWarning" class="hidden flex items-center gap-2 mt-1 text-red-500 text-xs">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert flex-shrink-0"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
              <p>Please select a size before adding to cart.</p>
            </div>
          </div>
        {% endif %}
        
        {# This is hidden if sizes exist, but good for fallback #}
        {% if product.sizes is empty %}
            <p class="text-sm text-gray-500 mt-4">Total Stock: {{ product.stock }}</p>
        {% endif %}
      </div>

      <div class="mt-6 flex flex-col gap-3">
        <div class="flex items-center gap-3">
          <label class="text-[#835234] font-semibold">Quantity:</label>
          <div class="flex items-center border rounded-lg overflow-hidden">
            <button id="decreaseQty" class="px-3 py-1 bg-pink-100 hover:bg-pink-200">−</button>
            <input id="quantityInput" type="number" value="1" min="1" max="{{ product.stock }}"
                   class="w-16 text-center border-l border-r outline-none">
            <button id="increaseQty" class="px-3 py-1 bg-pink-100 hover:bg-pink-200">+</button>
          </div>
        </div>

        <div class="flex gap-3">
          <button id="addToCartBtn" 
                  class="flex-1 bg-[#835234] hover:bg-[#6d412a] text-white py-2 rounded-xl transition">
            Add to Cart
          </button>
          <button id="addToFavouriteBtn" 
                  class="bg-pink-100 hover:bg-pink-200 text-[#835234] p-2 rounded-xl transition relative">
            <svg id="heartIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart transition-all duration-300"><path d="M19.5 12.571 12 20l-7.5-7.429A5 5 0 0 1 12 6a5 5 0 0 1 7.5 6.571Z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<style>
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}
.shake {
  animation: shake 0.3s ease-in-out;
}
</style>

<script>
window.addEventListener("servicesReady", () => {
  const container = document.querySelector("[data-product-id]");
  if (!container) return;

  const qtyInput = document.getElementById("quantityInput");
  const decBtn = document.getElementById("decreaseQty");
  const incBtn = document.getElementById("increaseQty");
  const sizeButtons = Array.from(document.querySelectorAll("[data-size]"));
  const sizeWarning = document.getElementById("sizeWarning");
  const sizeSelector = document.getElementById("sizeSelector");
  const addToCartBtn = document.getElementById("addToCartBtn");
  const addToFavouriteBtn = document.getElementById("addToFavouriteBtn");
  const heartIcon = document.getElementById("heartIcon");
  
  const priceDisplay = document.getElementById("productPriceDisplay");

  const product = {
    id: Number(container.dataset.productId),
    name: container.dataset.productName,
    price: Number(container.dataset.productPrice), // This is the base/starting price
    image: container.dataset.productImage,
    stock: Number(container.dataset.productStock || "1"),
    sizes: JSON.parse(container.dataset.productSizes || "[]"),
  };

  let selectedSize = null;
  let selectedStock = 0;
  let selectedPrice = product.price; // Default to base price

  const updateHeartUI = () => {
    const inFav = window.favouriteService.isFavourite(product.id); 
    if (inFav) {
      heartIcon.classList.add("fill-current", "text-pink-600");
    } else {
      heartIcon.classList.remove("fill-current", "text-pink-600");
    }
  };

  const getAvailableStockForSelectedSize = () => {
    if (product.sizes.length > 0 && !selectedSize) return 0;

    const baseStock = (selectedSize)
        ? selectedStock
        : product.stock; // Stock for products with no sizes
    
    const cart = window.cartService.getCart(); 
    
    const existing = cart.find(
      p => Number(p.id) === product.id && (p.selectedSize ?? null) === (selectedSize ?? null)
    );
    const existingQty = existing ? Number(existing.quantity || 0) : 0;
    
    return Math.max(0, baseStock - existingQty);
  };

  const refreshQuantityUI = () => {
    if (product.sizes.length > 0) {
        if (!selectedSize) {
          addToCartBtn.classList.add("opacity-60", "cursor-not-allowed");
          addToCartBtn.dataset.disabled = "true";
          qtyInput.value = 1;
          decBtn.disabled = true;
          incBtn.disabled = true;
          
          // Reset price display when no size is selected
          if (priceDisplay) {
              priceDisplay.textContent = `Starts at ₱${product.price.toFixed(2)}`;
          }
          return;
        }
    }
    
    const available = getAvailableStockForSelectedSize();

    addToCartBtn.classList.remove("opacity-60", "cursor-not-allowed");
    addToCartBtn.dataset.disabled = "false";
    
    if (available <= 0) {
      addToCartBtn.classList.add("opacity-60", "cursor-not-allowed");
      addToCartBtn.dataset.disabled = "true";
      addToCartBtn.textContent = "Out of Stock";
    } else {
      addToCartBtn.classList.remove("opacity-60", "cursor-not-allowed");
      addToCartBtn.dataset.disabled = "false";
      addToCartBtn.textContent = "Add to Cart";
    }

    decBtn.disabled = Number(qtyInput.value) <= 1;
    incBtn.disabled = Number(qtyInput.value) >= available;
    qtyInput.max = available;
  };

  // --- Size selection ---
  sizeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      sizeButtons.forEach(b => b.classList.remove("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]"));
      sizeButtons.forEach(b => b.classList.add("bg-pink-100", "text-pink-700"));

      btn.classList.remove("bg-pink-100", "text-pink-700");
      btn.classList.add("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]");

      selectedSize = btn.dataset.size;
      selectedStock = Number(btn.dataset.stock);
      
      selectedPrice = Number(btn.dataset.price); // Get price from button
      if (priceDisplay) {
        priceDisplay.textContent = `₱${selectedPrice.toFixed(2)}`; // Update UI
      }

      
      sizeWarning.classList.add("hidden");
      qtyInput.value = 1;
      refreshQuantityUI();
    });
  });

  if (product.sizes.length === 1) {
    sizeButtons[0].click();
  }
  
  // --- Quantity buttons ---
  decBtn.addEventListener("click", () => {
    qtyInput.value = Math.max(1, Number(qtyInput.value) - 1);
    refreshQuantityUI();
  });

  incBtn.addEventListener("click", () => {
    const available = getAvailableStockForSelectedSize();
    qtyInput.value = Math.min(Number(qtyInput.value) + 1, available);
    refreshQuantityUI();
  });

  qtyInput.addEventListener("input", (e) => {
    const available = getAvailableStockForSelectedSize();
    if (Number(e.target.value) > available) e.target.value = available;
    if (Number(e.target.value) < 1) e.target.value = 1;
    refreshQuantityUI();
  });

  // --- Add to Cart ---
  addToCartBtn.addEventListener("click", () => {
    if (product.sizes.length > 0 && !selectedSize) {
      sizeWarning.classList.remove("hidden");
      sizeSelector.classList.add("shake");
      setTimeout(() => sizeSelector.classList.remove("shake"), 300);
      return;
    }

    const availableStock = getAvailableStockForSelectedSize();
    if (availableStock <= 0) {
      window.showModal({
        type: "warning",
        title: "Out of Stock",
        message: `Sorry, ${product.name}${selectedSize ? " (" + selectedSize + ")" : ""} is out of stock.`,
        buttons: [{ text: "OK", variant: "cancel" }],
      });
      return;
    }
    
    const requested = Math.min(Number(qtyInput.value) || 1, availableStock);

    window.cartService.addItem({
        id: product.id,
        name: product.name,
        image: product.image,
        price: selectedPrice, // Use the dynamic selectedPrice
        selectedSize,
        stock: selectedSize ? selectedStock : product.stock,
    }, requested);

    window.showModal({
        type: "success",
        title: "Added to Cart",
        message: `${product.name}${selectedSize ? " (" + selectedSize + ")" : ""} × ${requested} added successfully.`,
        buttons: [{ text: "OK", variant: "confirm" }],
    });

    // Reset UI
    qtyInput.value = 1;
    if (product.sizes.length > 0) {
        selectedSize = null;
        selectedStock = 0;
        selectedPrice = product.price; // Reset price to base
        sizeButtons.forEach(b => {
          b.classList.remove("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]");
          b.classList.add("bg-pink-100", "text-pink-700");
        });
    }
    refreshQuantityUI();
  });


  addToFavouriteBtn.addEventListener("click", () => {
    const wasAdded = window.favouriteService.toggle(product);
    
    if (wasAdded) {
        window.showModal({
          type: "success",
          title: "Added to Favourites",
          message: `${product.name} has been added to your favourites.`,
          buttons: [{ text: "OK", variant: "confirm" }],
        });
    } else {
        window.showModal({
          type: "info",
          title: "Removed from Favourites",
          message: `${product.name} has been removed from your favourites.`,
          buttons: [{ text: "OK", variant: "cancel" }],
        });
    }
  });

  window.addEventListener("favouritesChanged", updateHeartUI);
  window.addEventListener("cartChanged", refreshQuantityUI);
  window.addEventListener("storage", () => {
    refreshQuantityUI();
    updateHeartUI();
  });

  // --- Initial Load ---
  refreshQuantityUI();
  updateHeartUI();
});
</script>
{% endblock %}
