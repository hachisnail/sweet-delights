{#
  Receives:
    - data (the order array)
    - beforeData (optional — previous state)
    - isAfterState (boolean) → true = highlight differences, false = plain view
#}

{% set isAfterState = isAfterState is defined ? isAfterState : true %}
{% set beforeData = beforeData is defined ? beforeData : {} %}


<style>
.highlight-changed {
  background-color: #fff3cd;
  color: #8b4513;
  padding: 2px 5px;
  border-radius: 4px;
  transition: background-color 0.3s ease;
}
</style>

{% if data %}
<div class="p-4 space-y-6 bg-white rounded-lg">

  {# --- Header (Unchanged) --- #}
  <div class="border-b border-pink-200 pb-3">
    <h3 class="text-xl font-bold text-[#835234]">
      Order #{{ data.id is defined ? data.id : '—' }}
    </h3>
    <p class="text-sm text-gray-500">
      Placed on {{ data.date is defined ? (data.date | date('M d, Y, h:i A')) : 'N/A' }}
    </p>
  </div>

  {# --- Order Info Grid (Unchanged) --- #}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    {# --- Customer --- #}
    {% set customerChanged = isAfterState and beforeData.customer_name is defined and beforeData.customer_name != data.customer_name %}
    <div class="p-4 rounded-lg border transition
      {% if isAfterState and customerChanged %} bg-yellow-50 border-yellow-300 shadow-sm {% else %} bg-gray-50 border-gray-200 {% endif %}
    ">
      <h4 class="text-md font-semibold text-[#a07445] mb-2">Customer</h4>
      <p class="text-gray-800 font-medium">
        {{ data.customer_name is defined ? data.customer_name : 'N/A' }}
      </p>
    </div>

    {# --- Status --- #}
    {% set statusChanged = isAfterState and beforeData.status is defined and beforeData.status != data.status %}
    <div class="p-4 rounded-lg border transition
      {% if isAfterState and statusChanged %} bg-yellow-50 border-yellow-300 shadow-sm {% else %} bg-gray-50 border-gray-200 {% endif %}
    ">
      <h4 class="text-md font-semibold text-[#a07445] mb-2">Status</h4>
      <span class="text-sm font-semibold px-3 py-1 rounded-full
        {% if data.status == 'Delivered' %} bg-green-100 text-green-700
        {% elseif data.status == 'Shipped' %} bg-blue-100 text-blue-700
        {% elseif data.status == 'Processing' %} bg-yellow-100 text-yellow-700
        {% else %} bg-gray-100 text-gray-700
        {% endif %}
      ">
        {{ data.status is defined ? data.status : 'Unknown' }}
      </span>
    </div>

  </div>

  {# --- Items (MODIFIED) --- #}
  <div>
    <h4 class="text-lg font-semibold text-[#a07445] mb-3">Items</h4>

    {% if data.items is defined and data.items|length > 0 %}
      <div class="divide-y divide-gray-100 border border-gray-200 rounded-lg">
        {% for item in data.items %}
          {% set matchedBefore = beforeData.items is defined
            ? (beforeData.items|filter(i => i.product_name == item.product_name)|first)
            : null
          %}
          {# --- MODIFIED: Added original_price to change check --- #}
          {% set itemChanged = isAfterState and matchedBefore and (
              matchedBefore.quantity != item.quantity
              or matchedBefore.price != item.price
              or matchedBefore.original_price != item.original_price
              or matchedBefore.size != item.size
          ) %}
          <div class="flex items-center gap-4 p-3 transition
            {% if isAfterState and itemChanged %} bg-yellow-50 border-l-4 border-yellow-300 {% endif %}
          ">
            <img
              src="{{ item.image | default('/Assets/placeholder-item.png') }}"
              alt="{{ item.product_name }}"
              class="w-14 h-14 rounded-lg object-cover border border-gray-200 bg-gray-50"
              onerror="this.onerror=null;this.src='/Assets/placeholder-item.png';"
            >
            <div class="flex-1">
              <p class="font-medium text-gray-900">{{ item.product_name }}</p>
              {% if item.size is defined and item.size %}
                <p class="text-sm text-gray-500">Size: {{ item.size }}</p>
              {% endif %}
              <p class="text-sm text-gray-500">Qty: {{ item.quantity }}</p>
            </div>
            
            {# --- MODIFIED: Price block to show discount --- #}
            <div class="text-right">
              <p class="text-gray-900 font-semibold">
                ₱{{ (item.price * item.quantity)|number_format(2) }}
              </p>
              {% if item.original_price is defined and item.original_price > item.price %}
                <p class="text-xs text-gray-500">(<span class="font-bold text-red-600">₱{{ item.price|number_format(2) }}</span> <span class="line-through">₱{{ item.original_price|number_format(2) }}</span> each)</p>
              {% else %}
                <p class="text-xs text-gray-500">(₱{{ item.price|number_format(2) }} each)</p>
              {% endif %}
            </div>
            {# --- END MODIFIED --- #}

          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500 italic">No items found.</p>
    {% endif %}
  </div>

  {# --- Totals (MODIFIED) --- #}
  {% set subtotalChanged = isAfterState and (beforeData.subtotal != data.subtotal) %}
  {% set discountChanged = isAfterState and (beforeData.total_discount ?? 0) != (data.total_discount ?? 0) %}
  {% set taxChanged = isAfterState and (beforeData.tax != data.tax) %}
  {% set shippingChanged = isAfterState and (beforeData.shipping_fee != data.shipping_fee) %}
  {% set totalChanged = isAfterState and (beforeData.total != data.total) %}

  <div class="pt-4 border-t border-gray-200 space-y-1">
    <div class="flex justify-between text-gray-700 {% if isAfterState and subtotalChanged %} bg-yellow-50 border-l-4 border-yellow-300 px-2 {% endif %}">
      <span>Subtotal</span>
      <span>₱{{ data.subtotal is defined ? (data.subtotal|number_format(2)) : '0.00' }}</span>
    </div>

    {# --- NEW: Discount Line --- #}
    {% if (data.total_discount ?? 0) > 0 or (isAfterState and discountChanged) %}
      <div class="flex justify-between text-red-600 {% if isAfterState and discountChanged %} bg-yellow-50 border-l-4 border-yellow-300 px-2 {% endif %}">
        <span>Discounts</span>
        <span>- ₱{{ data.total_discount is defined ? (data.total_discount|number_format(2)) : '0.00' }}</span>
      </div>
    {% endif %}
    {# --- END NEW --- #}

    <div class="flex justify-between text-gray-700 {% if isAfterState and taxChanged %} bg-yellow-50 border-l-4 border-yellow-300 px-2 {% endif %}">
      <span>Tax</span>
      <span>₱{{ data.tax is defined ? (data.tax|number_format(2)) : '0.00' }}</span>
    </div>
    <div class="flex justify-between text-gray-700 {% if isAfterState and shippingChanged %} bg-yellow-50 border-l-4 border-yellow-300 px-2 {% endif %}">
      <span>Shipping</span>
      <span>₱{{ data.shipping_fee is defined ? (data.shipping_fee|number_format(2)) : '0.00' }}</span>
    </div>
    <div class="flex justify-between text-lg font-bold text-[#835234] pt-2 border-t border-pink-300 {% if isAfterState and totalChanged %} bg-yellow-50 border-l-4 border-yellow-300 px-2 {% endif %}">
      <span>Total</span>
      <span>₱{{ data.total is defined ? (data.total|number_format(2)) : '0.00' }}</span>
    </div>
  </div>

</div>
{% else %}
  <p class="text-gray-500 italic">N/A (e.g., a “create” action)</p>
{% endif %}