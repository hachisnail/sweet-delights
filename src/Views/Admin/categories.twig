{% extends "Layouts/admin.twig" %} {# Assumes 'Layouts/admin.twig' is your admin layout #}

{# This macro recursively renders the category tree #}
{# 1. ✅ ADD upload_url to macro parameters #}
{% macro render_categories(categories, level = 0, app_url, upload_url) %}
  {% import _self as macros %}
  <ul class="{{ level > 0 ? 'ml-6 border-l border-pink-200 pl-4' : 'space-y-3' }}">
    {% for category in categories %}
      <li class="p-3 bg-white rounded-lg shadow-sm flex justify-between items-center">
        {# 2. ✅ Update container to allow flex items for image #}
        <div class="font-medium text-[#835234] flex items-center gap-4"> 
          
          {# 3. ✅ Display the category image (optional, assumes image is for top-level) #}
          {% if category.image is defined and category.image and category.parent_id is null %} 
              <img src="{{ upload_url ~ category.image }}" alt="{{ category.name }} image" class="w-10 h-10 object-cover rounded-md border border-gray-200 shrink-0">
          {% endif %}
          
          <div>
            {{ category.name }}
            <span class="text-xs text-gray-400">(ID: {{ category.id }})</span>
          </div>
        </div>
        <div class="flex gap-2">
          
          {# ✅ CHANGED: "Edit" button is now a direct link #}
          <a href="{{ app_url }}/app/categories/{{ category.id }}/edit" 
              class="edit-category-btn px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">
              Edit
          </a>
          
          {# "Delete" button for confirmation modal #}
          <form action="{{ app_url }}/app/categories/{{ category.id }}/delete" method="POST" class="delete-form">
            <button type="button" 
                    data-category-name="{{ category.name|e('html_attr') }}"
                    class="delete-category-btn px-3 py-1 text-sm bg-red-100 text-red-700 rounded-md hover:bg-red-200">
                    Delete
            </button>
          </form>
        </div>
      </li>
      {% if category.children is defined and category.children|length > 0 %}
        <li>
          {# 4. ✅ Pass upload_url to the recursive call #}
          {{ macros.render_categories(category.children, level + 1, app_url, upload_url) }} 
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{% endmacro %}


{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-[#835234]">{{ title }}</h2>
    
    {# ✅ CHANGED: "Add New" button is now a direct link #}
    <a href="{{ app_url }}/app/categories/new"
       class="add-category-btn px-5 py-2 bg-pink-500 text-white rounded-xl font-semibold hover:bg-pink-600 transition">
        Add New Category
    </a>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
    {% import _self as macros %}
    {% if categories|length > 0 %}
      {# 5. ✅ Pass upload_url (which comes from the PHP controller) to the initial macro call #}
      {{ macros.render_categories(categories, 0, app_url, upload_url) }}
    {% else %}
      <p class="text-center text-gray-500">No categories found. Add one to get started!</p>
    {% endif %}
  </div>

</div>

{# --- ✅ UPDATED SCRIPT: No changes needed here for image display, only for interaction --- #}
<script>
// This function will attach all our event listeners
function setupCategoryPageListeners() {
  
  // --- LOGIC FOR CONFIRMATION MODAL (DELETE) ---
  document.querySelectorAll('.delete-category-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.preventDefault();
      
      const form = e.currentTarget.closest('form');
      const categoryName = e.currentTarget.dataset.categoryName || 'this category';
      
      window.showModal({
        type: "warning",
        title: "Confirm Deletion",
        message: `Are you sure you want to delete "${categoryName}"? This may orphan child categories.`,
        buttons: [
          {
            text: "Cancel",
            variant: "cancel"
          },
          {
            text: "Delete",
            variant: "danger",
            action: () => {
              form.submit();
            }
          }
        ]
      });
    });
  });
}

// --- This function will check if the modal service is ready. ---
function waitForModalService() {
  if (typeof window.showModal === 'function') {
    setupCategoryPageListeners();
  } else {
    console.warn("ModalService not ready, retrying in 100ms...");
    setTimeout(waitForModalService, 100);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  waitForModalService();
});
</script>
{% endblock %}