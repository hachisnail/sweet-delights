{% extends "Layouts/admin.twig" %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-[#835234]">{{ title }}</h2>
    </div>

    {# 1. ✅ ADD enctype="multipart/form-data" for file upload #}
    <form id="category-form" action="{{ form_action }}" method="POST" enctype="multipart/form-data" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-5">
        
        {# --- FORM MODE SWITCH --- #}
        {% if form_mode == 'edit' %}
            {# --- SCENARIO 1: SIMPLE EDIT FORM --- #}
            
            <div>
                <label for="name" class="block text-sm font-medium text-[#835234] mb-1">Category Name</label>
                <input type="text" id="name" name="name" value="{{ category.name | default('') }}" required
                        class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
            </div>

            <div>
                <label for="parent_id" class="block text-sm font-medium text-[#835234] mb-1">Parent Category</label>
                <select id="parent_id" name="parent_id"
                         class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white">
                    <option value="">-- None (Top Level Category) --</option>
                    {% for cat in all_categories %}
                        {# Prevent selecting itself or its children as a parent #}
                        {% if category.id is not defined or cat.id != category.id %} 
                            <option value="{{ cat.id }}" {{ (category.parent_id | default(0)) == cat.id ? 'selected' : '' }}>
                                {{ cat.name }}
                            </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            {# 2. ✅ IMAGE MANAGEMENT (EDIT MODE) #}
            <div id="image-upload-group">
                <label for="image" class="block text-sm font-medium text-[#835234] mb-1">Category Image (Upload to replace)</label>
                <input type="file" id="image" name="image" accept="image/*"
                       class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
                
                {% if category.image is defined and category.image %}
                    <div class="mt-3 flex items-center space-x-4">
                        <p class="text-sm text-gray-500">Current Image:</p>
                        <a href="{{ upload_url ~ category.image }}" target="_blank">
                             {# Assuming a small thumbnail view is okay, or just a link to the image #}
                             [Image of {{ category.name }} category thumbnail]
                        </a>
                        <label class="flex items-center text-sm text-red-600">
                            <input type="checkbox" name="delete_image" value="1" class="mr-1 rounded text-red-600"> 
                            Delete Current Image
                        </label>
                    </div>
                {% endif %}
            </div>

        {% else %}
            {# --- SCENARIO 2: ADVANCED CREATE FORM --- #}
            
            <div>
                <label for="parent_id_select" class="block text-sm font-medium text-[#835234] mb-1">Choose Action</label>
                <select id="parent_id_select" name="parent_id"
                         class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white">
                    <option value="">-- Select an Option --</option>
                    <option value="-1">Create a New Top-Level Category</option>
                    <option class='text-gray-400 ' value="" disabled>--- Add to Existing ---</option>
                    {% for cat in top_level_categories %}
                        <option value="{{ cat.id }}">
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div id="new-parent-name-group" class="hidden">
                <label for="new_parent_name" class="block text-sm font-medium text-[#835234] mb-1">New Top-Level Category Name</label>
                <input type="text" id="new_parent_name" name="new_parent_name"
                        class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
            </div>
            
            {# 3. ✅ IMAGE UPLOAD (CREATE MODE - only for new top-level) #}
            <div id="image-upload-create-group" class="hidden">
                 <label for="image" class="block text-sm font-medium text-[#835234] mb-1">Category Image (Optional for New Top-Level)</label>
                 <input type="file" id="image" name="image" accept="image/*"
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
                 <p class="mt-1 text-xs text-gray-500">Only applies when creating a new Top-Level category.</p>
            </div>

            <div id="sub-category-group" class="hidden">
                <label class="block text-sm font-medium text-[#835234] mb-1">Sub-categories to Add</label>
                <div id="sub-category-list" class="space-y-2">
                    <div class="flex items-center gap-2">
                        <input type="text" name="sub_category_names[]"
                                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                                 placeholder="Sub-category Name">
                        <button type="button" class="remove-subcategory-btn text-red-500 hover:text-red-700 font-bold p-1 w-10 flex-shrink-0 hidden">✕</button>
                    </div>
                </div>
                <button type="button" id="add-subcategory-btn"
                        class="mt-2 px-3 py-1 text-sm bg-green-100 text-green-700 rounded-md hover:bg-green-200">
                    + Add Another
                </button>
            </div>

        {% endif %}
        {# --- END FORM MODE SWITCH --- #}

        <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancel-btn"
                    class="px-5 py-2 bg-gray-200 text-gray-800 rounded-xl font-semibold hover:bg-gray-300 transition">
                Cancel
            </button>
            <button type="button" id="save-btn"
                    class="px-5 py-2 bg-pink-500 text-white rounded-xl font-semibold hover:bg-pink-600 transition">
                Save
            </button>
        </div>

    </form>
</div>

{# --- MODAL & FORM SCRIPT --- #}
<script>
// This function will attach all our event listeners
function setupFormListeners() {
    // ... (unchanged elements) ...
    const form = document.getElementById("category-form");
    const cancelBtn = document.getElementById("cancel-btn");
    const saveBtn = document.getElementById("save-btn");

    // --- 2. Advanced "Create" Form Elements ---
    const parentSelect = document.getElementById("parent_id_select");
    const newParentGroup = document.getElementById("new-parent-name-group");
    const newParentInput = document.getElementById("new_parent_name");
    const subCategoryGroup = document.getElementById("sub-category-group");
    const subCategoryList = document.getElementById("sub-category-list");
    const addSubcategoryBtn = document.getElementById("add-subcategory-btn");
    
    // 4. ✅ NEW: Create form image element
    const imageUploadCreateGroup = document.getElementById("image-upload-create-group");
    // The input itself will use the generic 'image' name as it's the only one submitted

    // --- 3. Logic for Advanced "Create" Form ---
    if (parentSelect) {
        parentSelect.addEventListener("change", (e) => {
            const selectedValue = e.target.value;
            
            if (selectedValue === "-1") {
                // "Create New" is selected
                newParentGroup.classList.remove("hidden");
                subCategoryGroup.classList.remove("hidden");
                imageUploadCreateGroup.classList.remove("hidden"); // 5. ✅ Show image upload
                newParentInput.required = true;
            } else if (selectedValue) {
                // "Add to Existing" is selected
                newParentGroup.classList.add("hidden");
                subCategoryGroup.classList.remove("hidden");
                imageUploadCreateGroup.classList.add("hidden"); // 6. ✅ Hide image upload
                newParentInput.required = false;
            } else {
                // Placeholder is selected
                newParentGroup.classList.add("hidden");
                subCategoryGroup.classList.add("hidden");
                imageUploadCreateGroup.classList.add("hidden"); // 7. ✅ Hide image upload
                newParentInput.required = false;
            }
        });
    }
    // ... (addSubcategoryBtn and subCategoryList listeners remain the same) ...
    if (addSubcategoryBtn) {
        addSubcategoryBtn.addEventListener("click", () => {
            const div = document.createElement("div");
            div.className = "flex items-center gap-2";
            div.innerHTML = `
                <input type="text" name="sub_category_names[]"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                       placeholder="Sub-category Name">
                <button type="button" class="remove-subcategory-btn text-red-500 hover:text-red-700 font-bold p-1 w-10 flex-shrink-0">✕</button>
            `;
            subCategoryList.appendChild(div);
        });
    }

    if (subCategoryList) {
        subCategoryList.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-subcategory-btn")) {
                e.target.closest(".flex").remove();
            }
        });
    }


    // --- 4. Modal Listeners (for Save/Cancel) ---
    // ... (cancelBtn and saveBtn listeners remain the same) ...
    if (cancelBtn) {
        cancelBtn.addEventListener("click", (e) => {
            e.preventDefault();
            window.showModal({
                type: "warning",
                title: "Confirm Cancel",
                message: "Are you sure you want to cancel? Any unsaved changes will be lost.",
                buttons: [
                    { text: "Stay", variant: "cancel" },
                    { 
                        text: "Leave", 
                        variant: "danger", 
                        action: () => {
                            window.location.href = "{{ app_url }}/app/categories";
                        }
                    }
                ]
            });
        });
    }

    if (saveBtn && form) {
        saveBtn.addEventListener("click", (e) => {
            e.preventDefault();
            
            if (!form.checkValidity()) {
                window.showModal({
                    type: "error",
                    title: "Missing Information",
                    message: "Please fill out all required fields (like Category Name) before saving.",
                    buttons: [{ text: "OK", variant: "cancel" }]
                });
                form.reportValidity();
                return;
            }

            window.showModal({
                type: "info",
                title: "Confirm Save",
                message: "Are you sure you want to save this category?",
                {% if form_mode == 'edit' %}
                warning: "Saving this category will regenerate the SKUs for all associated products. This is normal.",
                {% endif %}
                buttons: [
                    { text: "Cancel", variant: "cancel" },
                    { 
                        text: "Save", 
                        variant: "primary",
                        action: () => {
                            form.submit();
                        }
                    }
                ]
            });
        });
    }
}

// --- 5. Modal Service Waiter ---
function waitForModalService() {
    if (typeof window.showModal === 'function') {
        setupFormListeners();
    } else {
        console.warn("ModalService not ready, retrying in 100ms...");
        setTimeout(waitForModalService, 100);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    waitForModalService();
});
</script> 
{% endblock %}