{% extends "Layouts/admin.twig" %}

{% block content %}

{# 
  This macro recursively builds the <option> tags for the category dropdown.
  It must be defined *inside* the block.
#}
{% import _self as forms %}

{% macro category_options(category_list, level, current_parent_id, category_id_to_disable) %}

    {% import _self as forms %}
    
    {% for cat in category_list %}
        {# Check if this option should be selected #}
        {% set is_selected = (current_parent_id == cat.id) %}
        
        {# Check if this option should be disabled (a category can't be its own parent) #}
        {% set is_disabled = (category_id_to_disable == cat.id) %}

        <option value="{{ cat.id }}" 
                {{ is_selected ? 'selected' }} 
                {{ is_disabled ? 'disabled' }}>
            
            {# Fix for the 'repeat' filter: use a standard 'for' loop #}
            {% if level > 0 %}
                {% for i in 1..level %}&nbsp;&nbsp;{% endfor %}
                ↳ 
            {% endif %}
            {{- cat.name -}}

        </option>

        {# If this category has children, render them too #}
        {% if cat.children is defined %}
            {{ forms.category_options(cat.children, level + 1, current_parent_id, category_id_to_disable) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

<div class="max-w-7xl mx-auto">

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-[#835234]">{{ title }}</h2>
    </div>

    <form id="category-form" action="{{ form_action }}" method="POST" enctype="multipart/form-data" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-5">
        
        {# --- UNIFIED FORM FIELDS --- #}

        <div>
            <label for="parent_id_select" class="block text-sm font-medium text-[#835234] mb-1">Parent Category</label>
            <select id="parent_id_select" name="parent_id"
                    class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white">
                                    
                        {% if form_mode == 'create' %}
                        {# --- CREATE MODE OPTIONS --- #}
                        <option value="-1" selected>
                            -- Create New Top-Level Category --
                        </option>
                        <option value="" disabled>
                            -- Add as a sub-category to... --
                        </option>

                        {# Only show top-level categories here #}
                        {% for cat in nested_categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    {% else %}

                    {# --- EDIT MODE OPTIONS --- #}
                    <option value="" {{ category.parent_id is null ? 'selected' }}>
                        -- None (Top Level Category) --
                    </option>
                    {{ forms.category_options(nested_categories, 0, category.parent_id, category.id) }}
                {% endif %}

            </select>
        </div>
        
        {# This field is for "Create New" or "Edit" #}
        <div id="category-name-group" class="{% if form_mode == 'create' %}hidden{% endif %}">
            <label for="category_name" class="block text-sm font-medium text-[#835234] mb-1">
                {% if form_mode == 'create' %}New Top-Level Category Name{% else %}Category Name{% endif %}
            </label>
            <input type="text" id="category_name" name="{% if form_mode == 'create' %}new_parent_name{% else %}name{% endif %}"
                   value="{{ category.name | default('') }}" 
                   {% if form_mode == 'edit' %}required{% endif %}
                   class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
        </div>

        {# This field is ONLY for "Create New" #}
        {% if form_mode == 'create' %}
            <div id="sub-category-group" class="hidden">
                <label class="block text-sm font-medium text-[#835234] mb-1">Sub-categories to Add</label>
                <div id="sub-category-list" class="space-y-2">
                    <div class="flex items-center gap-2">
                        <input type="text" name="sub_category_names[]"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                               placeholder="Sub-category Name">
                        <button type="button" class="remove-subcategory-btn text-red-500 hover:text-red-700 font-bold p-1 w-10 shrink-0 hidden">✕</button>
                    </div>
                </div>
                <button type="button" id="add-subcategory-btn"
                        class="mt-2 px-3 py-1 text-sm bg-green-100 text-green-700 rounded-md hover:bg-green-200">
                    + Add Another
                </button>
            </div>
        {% endif %}
        
        {# --- IMAGE UPLOAD (Works for both modes) --- #}
        <div id="image-upload-group">
            <label for="image" class="block text-sm font-medium text-[#835234] mb-1">
                {% if form_mode == 'edit' %}Category Image (Upload to replace){% else %}Category Image (Optional for New Top-Level){% endif %}
            </label>
            <input type="file" id="image" name="image" accept="image/*"
                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
            
            {% if form_mode == 'edit' and category.image %}
                <div class="mt-3 flex items-center space-x-4">
                    <p class="text-sm text-gray-500">Current Image:</p>
                    <a href="{{ upload_url ~ category.image }}" target="_blank">
                        
                    </a>
                    <label class="flex items-center text-sm text-red-600">
                        <input type="checkbox" name="delete_image" value="1" class="mr-1 rounded text-red-600"> 
                        Delete Current Image
                    </label>
                </div>
            {% elseif form_mode == 'create' %}
                <p id="image-upload-note" class="mt-1 text-xs text-gray-500">Only applies when creating a new Top-Level category.</p>
            {% endif %}
        </div>
        
        {# --- BUTTONS --- #}
        <div class="flex justify-end gap-3 pt-4">
            <button type="button" id="cancel-btn"
                    class="px-5 py-2 bg-gray-200 text-gray-800 rounded-xl font-semibold hover:bg-gray-300 transition">
                Cancel
            </button>
            <button type="button" id="save-btn"
                    class="px-5 py-2 bg-pink-500 text-white rounded-xl font-semibold hover:bg-pink-600 transition">
                Save
            </button>
        </div>

    </form>
</div>

{# --- MODAL & FORM SCRIPT --- #}
<script>
function setupFormListeners() {
    const form = document.getElementById("category-form");
    const cancelBtn = document.getElementById("cancel-btn");
    const saveBtn = document.getElementById("save-btn");

    // --- Form Elements ---
    const parentSelect = document.getElementById("parent_id_select");
    const nameGroup = document.getElementById("category-name-group");
    const nameInput = document.getElementById("category_name");
    
    // "Create" mode only elements
    const subCategoryGroup = document.getElementById("sub-category-group");
    const subCategoryList = document.getElementById("sub-category-list");
    const addSubcategoryBtn = document.getElementById("add-subcategory-btn");
    const imageUploadGroup = document.getElementById("image-upload-group");
    const imageUploadNote = document.getElementById("image-upload-note");

    // --- Logic for "Create" Form ---
    function toggleCreateForm(selectedValue) {
        if (selectedValue === "-1") {
            // "Create New"
            nameGroup.classList.remove("hidden");
            nameInput.required = true;
            
            subCategoryGroup.classList.remove("hidden");
            imageUploadGroup.classList.remove("hidden");
            if (imageUploadNote) imageUploadNote.classList.remove("hidden");
            
        } else if (selectedValue) {
            // "Add to Existing"
            nameGroup.classList.add("hidden");
            nameInput.required = false;
            
            subCategoryGroup.classList.remove("hidden");
            imageUploadGroup.classList.add("hidden");
            if (imageUploadNote) imageUploadNote.classList.add("hidden");

        } else {
            // Placeholder
            nameGroup.classList.add("hidden");
            nameInput.required = false;

            subCategoryGroup.classList.add("hidden");
            imageUploadGroup.classList.add("hidden");
            if (imageUploadNote) imageUploadNote.classList.add("hidden");
        }
    }

    // Attach listener for the dropdown
    if (parentSelect && '{{ form_mode }}' === 'create') {
        parentSelect.addEventListener("change", (e) => {
            toggleCreateForm(e.target.value);
        });
        // Run on page load
        toggleCreateForm(parentSelect.value);
    }
    
    // --- Sub-category Listeners (Unchanged) ---
    if (addSubcategoryBtn) {
        addSubcategoryBtn.addEventListener("click", () => {
            const div = document.createElement("div");
            div.className = "flex items-center gap-2";
            div.innerHTML = `
                <input type="text" name="sub_category_names[]"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                       placeholder="Sub-category Name">
                <button type="button" class="remove-subcategory-btn text-red-500 hover:text-red-700 font-bold p-1 w-10 flex-shrink-0">✕</button>
            `;
            subCategoryList.appendChild(div);
        });
    }

    if (subCategoryList) {
        subCategoryList.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-subcategory-btn")) {
                e.target.closest(".flex").remove();
            }
        });
    }

    // --- Modal Listeners (Unchanged) ---
    if (cancelBtn) {
        cancelBtn.addEventListener("click", (e) => {
            e.preventDefault();
            window.showModal({
                type: "warning",
                title: "Confirm Cancel",
                message: "Are you sure you want to cancel? Any unsaved changes will be lost.",
                buttons: [
                    { text: "Stay", variant: "cancel" },
                    { 
                        text: "Leave", 
                        variant: "danger", 
                        action: () => {
                            window.location.href = "{{ app_url }}/app/categories";
                        }
                    }
                ]
            });
        });
    }

    if (saveBtn && form) {
        saveBtn.addEventListener("click", (e) => {
            e.preventDefault();
            
            if (!form.checkValidity()) {
                window.showModal({
                    type: "error",
                    title: "Missing Information",
                    message: "Please fill out all required fields before saving.",
                    buttons: [{ text: "OK", variant: "cancel" }]
                });
                form.reportValidity();
                return;
            }

            window.showModal({
                type: "info",
                title: "Confirm Save",
                message: "Are you sure you want to save this category?",
                {% if form_mode == 'edit' %}
                warning: "Saving this category will regenerate the SKUs for all associated products. This is normal.",
                {% endif %}
                buttons: [
                    { text: "Cancel", variant: "cancel" },
                    { 
                        text: "Save", 
                        variant: "primary",
                        action: () => {
                            form.submit();
                        }
                    }
                ]
            });
        });
    }
}

// --- Modal Service Waiter (Unchanged) ---
function waitForModalService() {
    if (typeof window.showModal === 'function') {
        setupFormListeners();
    } else {
        console.warn("ModalService not ready, retrying in 100ms...");
        setTimeout(waitForModalService, 100);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    waitForModalService();
});
</script> 
{% endblock %}