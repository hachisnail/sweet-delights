{% extends "Layouts/admin.twig" %} 

{% block content %} 
<div class="max-w-7xl mx-auto"> 

  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-[#835234]">{{ title }}</h2>
  </div>

  <form id="product-form" action="{{ form_action }}" method="POST" enctype="multipart/form-data"   
        class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-6"> 

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
      <div> 
        <label for="name" class="block text-sm font-medium text-[#835234] mb-1">Product Name</label> 
        <input type="text" id="name" name="name" value="{{ product.name | default('') }}" required 
               class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"> 
      </div> 
      <div> 
        <label for="category_id" class="block text-sm font-medium text-[#835234] mb-1">Category</label> 
        <select id="category_id" name="category_id" required 
                class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white"> 
          <option value="">-- Select a Category --</option> 
          
          {# ✅ --- START: UPDATED LOGIC --- #}
          {% for cat in all_categories %} 
            {# Check if this is a top-level category (it has no parent) #}
            {% set is_top_level = cat.parent_id is null %}
            
            <option 
                value="{{ cat.id }}" 
                {{ (product.category_id | default(0)) == cat.id ? 'selected' : '' }}
                
                {# Add 'disabled' attribute if it's a top-level category #}
                {{ is_top_level ? 'disabled' : '' }}
                
                {# Add a visual style for the disabled option #}
                class="{{ is_top_level ? 'text-gray-400' : '' }}">
                
                {{ cat.indented_name | raw }}
                
                {# Add a helper text for the disabled option #}
                {{ is_top_level ? ' (Select a Sub-category)' : '' }}
            </option> 
          {% endfor %} 
          {# ✅ --- END: UPDATED LOGIC --- #}

        </select> 
      </div> 
    </div> 
     
    <div> 
      <label for="description" class="block text-sm font-medium text-[#835234] mb-1">Description</label> 
      <textarea id="description" name="description" rows="4" 
                class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">{{ product.description | default('') }}</textarea> 
    </div> 

    <!-- --- ✅ NEW: IS_LISTED TOGGLE --- -->
    <div class="mt-4">
      <label for="is_listed" class="flex items-center space-x-3 cursor-pointer">
        <input type="checkbox" id="is_listed" name="is_listed" class="h-5 w-5 rounded border-gray-300 text-pink-600 focus:ring-pink-500" 
               {{ product.is_listed | default(true) ? 'checked' : '' }}>
        <span class="text-sm font-medium text-[#835234]">
          Product is listed and visible to customers
        </span>
      </label>
      <p class="text-xs text-gray-500 mt-1 pl-8">
        If unchecked, this product will be hidden from the public store (unlisted).
      </p>
    </div>
    <!-- --- END: IS_LISTED TOGGLE --- -->

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> 
      <div id="main-price-field"> 
        <label for="price" class="block text-sm font-medium text-[#835234] mb-1">Price (₱)</label> 
        <input type="number" id="price" name="price" value="{{ product.price | default(0) }}" required step="0.01" 
               class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" 
               {% if product.sizes|length > 0 %}readonly{% endif %}> 
         <p class="text-xs text-gray-500 mt-1" id="price-helper"> 
           {% if product.sizes|length > 0 %}Base price is auto-set to lowest size price.{% else %}Set the price for products without sizes.{% endif %} 
         </p> 
      </div> 
       
      <div id="main-stock-field"> 
        <label for="stock" class="block text-sm font-medium text-[#835234] mb-1">Total Stock</label> 
        <input type="number" id="stock" name="stock" value="{{ product.stock | default(0) }}" 
               class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" 
               {% if product.sizes|length > 0 %}readonly{% endif %}> 
        <p class="text-xs text-gray-500 mt-1" id="stock-helper"> 
          {% if product.sizes|length > 0 %}Stock is auto-calculated from sizes.{% else %}Only fill this if your product has no sizes.{% endif %} 
        </p> 
      </div> 
    </div> 

    <div> 
      <label for="image" class="block text-sm font-medium text-[#835234] mb-1">Main Product Image</label> 
      {% if product.image %} 
        <div class="flex items-center gap-4 mb-2"> 
          <img src="{{ product.image }}" onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';" alt="Current Image" class="w-20 h-20 object-cover rounded-lg shadow-sm"> 
          <span class="text-gray-500 text-sm">Current image. Upload a new file below to replace it.</span> 
        </div> 
      {% endif %} 
      <input type="file" id="image" name="image" {{ (product.image or product.sizes[0].image) ? '' : 'required' }} 
             class="w-full text-sm text-gray-500 
                    file:mr-4 file:py-2 file:px-4 
                    file:rounded-full file:border-0 
                    file:text-sm file:font-semibold 
                    file:bg-pink-100 file:text-pink-700 
                    hover:file:bg-pink-200"> 
    </div> 
     
    <hr class="border-pink-100"> 

    {# ✅ --- START: REDESIGNED SIZES & VARIANTS SECTION --- #}
    <div id="sizes-container"> 
      <div class="flex justify-between items-center mb-4"> 
        <h3 class="text-lg font-semibold text-[#835234]">Sizes & Variants</h3> 
        <button type="button" id="add-size-btn"   
                class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg font-semibold hover:bg-green-200 transition flex items-center gap-1"> 
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Add Size 
        </button> 
      </div> 
       
      <div id="sizes-list" class="space-y-4"> 
        {# ✅ REMOVED: The old grid header #}
       
        {% for size in product.sizes|default([]) %} 
          <div class="relative p-4 bg-gray-50 rounded-lg border border-gray-400 size-row space-y-4"> 
            
            <button type="button" class="remove-size-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 font-bold p-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <input type="hidden" name="sizes_existing_image[]" value="{{ size.image | default('') }}">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Size Name</label>
                    <input type="text" name="sizes_name[]" placeholder="E.g. Small, 6-pack" value="{{ size.name }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"> 
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Price (₱)</label>
                    <input type="number" name="sizes_price[]" placeholder="Price" value="{{ size.price | default(0) }}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm size-price-input"> 
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Stock</label>
                    <input type="number" name="sizes_stock[]" placeholder="Stock" value="{{ size.stock }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm size-stock-input"> 
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Current Image</label>
                    <div class="h-20 w-20 bg-gray-100 rounded-lg flex items-center justify-center">
                        {% if size.image %}
                            <img src="{{ size.image }}" onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';" alt="Current Size Image" class="h-full w-full object-cover rounded-lg shadow-sm">
                        {% else %}
                            <span class="text-xs text-gray-400">No image</span>
                        {% endif %}
                    </div>
                </div>
                 <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Upload New Image</label>
                    <input type="file" name="sizes_image[]" class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
                 </div>
            </div>
          </div> 
        {% endfor %} 
      </div> 
    </div> 
    {# ✅ --- END: REDESIGNED SIZES & VARIANTS SECTION --- #}


    <div class="flex justify-end gap-3 pt-6"> 
      <button type="button" id="cancel-btn"
            class="px-5 py-2 bg-gray-200 text-gray-800 rounded-xl font-semibold hover:bg-gray-300 transition"> 
        Cancel 
      </button> 
      <button type="button" id="save-btn"
               class="px-5 py-2 bg-pink-500 text-white rounded-xl font-semibold hover:bg-pink-600 transition"> 
        Save Product 
      </button> 
    </div> 

  </form> 
</div> 

<script> 
// This function will attach all our event listeners
function setupFormListeners() {
  const sizesList = document.getElementById("sizes-list"); 
  const addSizeBtn = document.getElementById("add-size-btn"); 
  const mainStockInput = document.getElementById("stock"); 
  const stockHelper = document.getElementById("stock-helper"); 
  const mainPriceInput = document.getElementById("price"); 
  const priceHelper = document.getElementById("price-helper"); 
  const sizeHeader = document.getElementById("size-header"); // This element is no longer used but safe to keep

  const form = document.getElementById("product-form");
  const cancelBtn = document.getElementById("cancel-btn");
  const saveBtn = document.getElementById("save-btn");

  const createSizeRow = () => { 
    const div = document.createElement("div"); 
    // ✅ --- START: UPDATED JAVASCRIPT ---
    div.className = "relative p-4 bg-gray-50 rounded-lg border border-gray-200 size-row space-y-4"; 
    div.innerHTML = ` 
        <button type="button" class="remove-size-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 font-bold p-1 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        
        <input type="hidden" name="sizes_existing_image[]" value="">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Size Name</label>
                <input type="text" name="sizes_name[]" placeholder="E.g. Small, 6-pack" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"> 
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Price (₱)</label>
                <input type="number" name="sizes_price[]" placeholder="Price" value="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm size-price-input"> 
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Stock</label>
                <input type="number" name="sizes_stock[]" placeholder="Stock" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm size-stock-input"> 
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Current Image</label>
                <div class="h-20 w-20 bg-gray-100 rounded-lg flex items-center justify-center">
                    <span class="text-xs text-gray-400">No image</span>
                </div>
            </div>
             <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Upload New Image</label>
                <input type="file" name="sizes_image[]" class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
             </div>
        </div>
    `; 
    // ✅ --- END: UPDATED JAVASCRIPT ---
    sizesList.appendChild(div); 
    updateMainFieldsState(); 
  }; 

  const updateMainFieldsState = () => { 
    const sizeRows = sizesList.querySelectorAll(".size-row").length; 
    if (sizeRows > 0) { 
      mainStockInput.readOnly = true; 
      mainPriceInput.readOnly = true; 
      stockHelper.textContent = "Stock is auto-calculated from sizes."; 
      priceHelper.textContent = "Base price is auto-set to lowest size price."; 
      // ✅ REMOVED: sizeHeader logic
      calculateTotals(); 
    } else { 
      mainStockInput.readOnly = false; 
      mainPriceInput.readOnly = false; 
      stockHelper.textContent = "Only fill this if your product has no sizes."; 
      priceHelper.textContent = "Set the price for products without sizes."; 
      // ✅ REMOVED: sizeHeader logic
    } 
  }; 
  
  const calculateTotals = () => { 
    let totalStock = 0; 
    let prices = []; 
    sizesList.querySelectorAll(".size-stock-input").forEach(input => { 
      totalStock += Number(input.value) || 0; 
    }); 
    sizesList.querySelectorAll(".size-price-input").forEach(input => { 
      prices.push(Number(input.value) || 0); 
    }); 
    
    mainStockInput.value = totalStock; 
    mainPriceInput.value = prices.length > 0 ? Math.min(...prices) : 0; 
  }; 

  if(addSizeBtn) {
    addSizeBtn.addEventListener("click", createSizeRow); 
  }
  if(sizesList) {
    sizesList.addEventListener("click", (e) => { 
      if (e.target.closest(".remove-size-btn")) { // ✅ Updated selector
        e.target.closest(".size-row").remove(); 
        updateMainFieldsState(); 
      } 
    }); 
    
    sizesList.addEventListener("input", (e) => { 
      if (e.target.classList.contains("size-stock-input") || e.target.classList.contains("size-price-input")) { 
        calculateTotals(); 
      } 
    }); 
  }
  
  if (cancelBtn) {
    cancelBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.showModal({
        type: "warning",
        title: "Confirm Cancel",
        message: "Are you sure you want to cancel? Any unsaved changes will be lost.",
        buttons: [
          { text: "Stay", variant: "cancel" },
          { 
            text: "Leave", 
            variant: "danger", 
            action: () => {
              window.location.href = "{{ app_url }}/app/products";
            }
          }
        ]
      });
    });
  }

  if (saveBtn && form) {
    saveBtn.addEventListener("click", (e) => {
      e.preventDefault();
      
      if (!form.checkValidity()) {
          window.showModal({
            type: "error",
            title: "Missing Information",
            message: "Please fill out all required fields (like Product Name and Category) before saving.",
            buttons: [{ text: "OK", variant: "cancel" }]
          });
        // Show native validation errors
        form.reportValidity();
        return;
      }

      window.showModal({
        type: "info",
        title: "Confirm Save",
        message: "Are you sure you want to save these changes?",
        buttons: [
          { text: "Cancel", variant: "cancel" },
          { 
            text: "Save", 
            variant: "primary", 
            action: () => {
              form.submit();
            }
          }
        ]
      });
    });
  }

  updateMainFieldsState(); 
}

// --- This function will check if the modal service is ready. ---
function waitForModalService() {
  if (typeof window.showModal === 'function') {
    setupFormListeners();
  } else {
    console.warn("ModalService not ready, retrying in 100ms...");
    setTimeout(waitForModalService, 100);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  waitForModalService();
});
</script> 
{% endblock %}
