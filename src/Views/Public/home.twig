{% extends "Layouts/public.twig" %}

{% set enable_scroll_snap = true %}

{% macro renderDiscountCard(discount, app_url) %}
    
    {% set url = discount.discount_scope == 'product' 
        ? app_url ~ '/products/' ~ discount.item_sku 
        : app_url ~ '/products?category=' ~ discount.item_sku 
    %}

    {# --- IMAGE LOGIC --- #}
    {% set image_src = '/Assets/placeholder-item.png' %}
    
    {% if discount.discount_scope == 'product' and discount.item_image %}
        {# Product images in DB already start with /Assets/Products/... #}
        {# We just use the raw string from the DB #}
        {% set image_src = discount.item_image %}
        
    {% elseif discount.discount_scope == 'category' %}
        {# Category images in DB are JUST the filename (e.g. "cookies.jpg") #}
        {# We manually add the folder path #}
        {% if discount.item_image %}
            {% set image_src = '/Assets/Categories/' ~ discount.item_image %}
        {% else %}
            {# If no image, try to find a png matching the slug #}
            {% set image_src = '/Assets/Categories/' ~ discount.item_sku ~ '.png' %}
        {% endif %}
    {% endif %}

    {# --- RENDER CARD --- #}
    <a href="{{ url }}" class="block bg-white rounded-lg shadow-md overflow-hidden group h-full border border-[#EADBCB]">
        <div class="relative h-48 bg-[#FFF8F2]">
            {# Added debugging: If it fails, it will print the path in console if you inspect #}
            <img src="{{ image_src }}" 
                 alt="{{ discount.item_name }}" 
                 class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" 
                 onerror="console.log('Failed to load:', this.src); this.onerror=null; this.src='/Assets/placeholder-item.png';">
            
            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors"></div>

            <span class="absolute top-2 right-2 bg-[#A96B44] text-white text-xs font-bold px-3 py-1 rounded-full shadow-md border border-[#C7A97E]">
                {% if discount.discount_type == 'percent' %}
                    {{ discount.discount_value | number_format(0) }}% OFF
                {% else %}
                    ₱{{ discount.discount_value | number_format(2) }} OFF
                {% endif %}
            </span>
        </div>
        
        <div class="p-4 flex flex-col gap-1">
            <p class="text-xs font-bold tracking-widest text-[#A96B44] uppercase opacity-70">{{ discount.discount_scope }} Deal</p>
            <h3 class="text-lg font-zen-antique font-bold text-[#5C3A2A] truncate group-hover:text-[#A96B44] transition-colors">
                {{ discount.item_name }}
            </h3>
            
            <div class="flex items-center gap-2 mt-2 pt-2 border-t border-[#EADBCB]">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" stroke="#A69273" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                <p class="text-xs text-[#A69273] font-medium">
                    {% if discount.end_date %}
                        Ends {{ discount.end_date | date('M j, Y') }}
                    {% else %}
                        Limited Time
                    {% endif %}
                </p>
            </div>
        </div>
    </a>
{% endmacro %}


{% block content %}

<section class="min-h-screen bg-cover bg-center bg-no-repeat px-6 sm:px-30 pt-20 sm:pt-15 flex items-center justify-center snap-start"
         style="background-image: url('{{ app_url }}/Assets/group-cover.png');">

  <div class="flex flex-col w-fit items-start justify-center gap-y-6">

    <div class="relative w-fit flex flex-col items-center justify-center">

      <div class="absolute top-1 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[120%] sm:w-[130%] -z-10 pointer-events-none select-none">
 
        <img src="{{ app_url }}/Assets/bg-banner.png" alt="" class="w-full h-auto object-contain opacity-90">
      </div>

      <div class="text-left z-10 px-4">
        <p class="font-zen-antique text-xl sm:text-5xl text-[#A96B44]">Welcome to</p>

        <h2 class="text-6xl lg:text-[9rem] leading-25 text-[#A96B44] 
                   font-zen-antique text-shadow-sm text-shadow-[#8c8989]">
          FlourEver
        </h2>

        <p class="font-zen-antique text-2xl text-[#A69273] mt-2">
          The sweet spots for cravings
        </p>
      </div>
      
    </div>

    <button onclick="location.href='{{ app_url }}/products'"
            class="z-20 bg-white shadow-md shadow-[#8c8989]/50 text-[#A96B44] flex gap-x-3 pr-3 pl-5 py-2 border border-[#6B4226] rounded-lg font-semibold hover:scale-105 transition">
      Order Now
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
        <path d="M5 12h14"/>
        <path d="m12 5 7 7-7 7"/>
      </svg>
    </button>

  </div>
</section>


{# --- ACTIVE DISCOUNTS CAROUSEL (Main Page) --- #}
{% if active_discounts is not empty %}
    <section class="py-16 bg-[#fff1e1] snap-start pt-25">
        <div class="w-full max-w-7xl mx-auto px-6">
            <h2 class="font-zen-antique text-3xl lg:text-6xl text-[#835234] text-shadow-sm text-shadow-[#d1bfa5] text-center mb-10">
                Sweet Deals Right Now
            </h2>
            
            <div class="swiper discountSwiper">
                <div class="swiper-wrapper">
                    {% for discount in active_discounts %}
                        <div class="swiper-slide h-auto">
                            {# Pass app_url to the macro #}
                            {{ _self.renderDiscountCard(discount, app_url) }} 
                        </div>
                    {% endfor %}
                </div>
                <div class="swiper-pagination mt-6 relative"></div>
            </div>
        </div>
    </section>
{% endif %}


{# --- EXPLORE OUR CATEGORIES SECTION --- #}
<section class="flex flex-col min-h-screen items-center justify-center snap-start pt-30 bg-[#FFF9F2] bg-cover bg-center bg-no-repea"
style="background-image: url('{{ app_url }}/Assets/category-bg.png');">
  <div class="w-fit flex flex-col items-center gap-y-4">
    <h1 class="font-zen-antique text-3xl lg:text-6xl text-[#835234] text-shadow-sm text-shadow-[#d1bfa5]">
      Explore Our Categories
    </h1>

    <div class="flex items-center gap-y-5">
      <div class="flex flex-col gap-y-3 justify-center items-end">
        <div class="w-30 lg:w-60 bg-[#A96B44] h-[0.1rem] rounded-full"></div>
        <div class="w-20 lg:w-45 bg-[#C7A97E] h-[0.1rem] rounded-full"></div>
      </div>

      {# Added app_url #}
      <img src="{{ app_url }}/Assets/BobaTea.svg" alt="Boba Teas" class="w-15">

      <div class="flex flex-col h-full gap-y-3 justify-center items-start">
        <div class="w-30 lg:w-60 bg-[#A96B44] h-[0.1rem] rounded-full"></div>
        <div class="w-20 lg:w-45 bg-[#C7A97E] h-[0.1rem] rounded-full"></div>
      </div>
    </div>

{# --- CATEGORY GRID --- #}
    <div class="min-h-90 w-full flex flex-wrap justify-center items-center gap-6 mt-8">
      
      {% for cat in categories %}
        {# Updated Logic to use app_url without leading slash issues #}
        {% set image_src = cat.image ? app_url ~ '/Assets/Categories/' ~ cat.image : app_url ~ '/Assets/Categories/' ~ cat.slug ~ '.png' %}
        
        <div class="relative bg-transparent">
<img src="/Assets/kitty.png" 
     class="absolute z-10 pointer-events-none select-none object-cover
            /* Mobile: Smaller, centered on top, slightly higher */
            w-24 -top-12 left-1/2 -translate-x-1/2
            
            /* Tablet: Slightly larger, moving to the right */
            md:w-32 md:left-28 md:translate-x-0
            
            /* Desktop: Original size and position */
            lg:w-auto lg:left-45 lg:-top-10" 
     onerror="this.style.display='none'">

          <div class="relative w-40 h-60 lg:w-60 lg:h-90 rounded-4xl overflow-hidden border-[#876041] border-4 shadow-md shadow-[#d4c2a8] bg-white flex flex-col items-center justify-end group hover:scale-[1.02] transition-transform duration-500">
          
            <a href="{{ app_url }}/products?category={{ cat.slug }}" class="absolute inset-0">
              <img 
                src="{{ image_src }}" 
                alt="{{ cat.name }}" 
                class="w-full h-full object-cover transition-transform duration-700 ease-in-out group-hover:scale-110"
                onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';">
            </a>

            <a href="{{ app_url }}/products?category={{ cat.slug }}"
               class="absolute bottom-4 left-1/2 -translate-x-1/2 w-32 lg:w-40 h-10 bg-[#A96B44]/50 border  text-white font-semibold rounded-full overflow-hidden group/button shadow-md hover:shadow-lg transition-all duration-300  border-[#835234]">
              
              <span class="absolute inset-1 bg-white opacity-25 
                           scale-x-0 origin-left group-hover/button:scale-x-100
                           transition-transform duration-500 ease-in-out rounded-full"></span>

              <span class="relative z-10 flex items-center justify-center h-full tracking-wide">
                {{ cat.name }}
              </span>
            </a>

          </div>
        </div>

      {% else %}

        {# --- EMPTY STATE PLACEHOLDER --- #}
        <div class="flex flex-col items-center justify-center py-10 opacity-70 animate-pulse">
            
            {# Circle Background #}
            <div class="w-32 h-32 bg-[#E8DCC4] rounded-full flex items-center justify-center mb-4 shadow-inner border-2 border-[#C7A97E] border-dashed">
                {# SVG Icon: Cookie/Pastry #}
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#835234" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/>
                    <path d="M8.5 8.5v.01"/>
                    <path d="M16 15.5v.01"/>
                    <path d="M12 12v.01"/>
                    <path d="M11 17v.01"/>
                    <path d="M7 14v.01"/>
                </svg>
            </div>
            
            <h3 class="font-zen-antique text-2xl text-[#835234]">Oven Empty</h3>
            <p class="text-[#A96B44] text-sm mt-1 font-zen-antique">We are baking new categories...</p>
            
        </div>

      {% endfor %}
    </div>

    <div class="flex flex-col items-center gap-y-3 h-15 justify-center mt-10">
      <div class="w-60 lg:w-200 bg-[#A96B44] rounded-full h-[0.1rem]"></div>
      <div class="w-30 lg:w-170 bg-[#C7A97E] rounded-full h-[0.1rem]"></div>
    </div>
  </div>
</section>

{# --- DISCOUNT POPUP --- #}
<div id="modalOverlay" class="fixed inset-0 bg-black/40 z-40 hidden" aria-hidden="true"></div>

{% if active_discounts is not empty %}
    <div id="discountModal" 
         class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-4xl z-50 hidden transform transition-all duration-300">
        
        <div class="relative bg-white shadow-2xl overflow-hidden h-auto md:h-[450px] rounded-lg">
            
            {# Close Button #}
            <button id="closeModalBtn" class="absolute top-4 right-4 z-30 p-1 bg-black/20 hover:bg-black/40 rounded-full text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                </svg>
            </button>

            <div class="swiper modalDiscountSwiper h-full w-full">
                <div class="swiper-wrapper">
                    
                    {% for promo in active_discounts %}
                        
                        {# --- FIXED IMAGE PATH LOGIC --- #}
                        {# 1. Default Fallback #}
                        {% set full_image_path = '/Assets/placeholder-item.png' %}

                        {# 2. Product Logic: DB stores full path like '/Assets/Products/img.jpg' #}
                        {% if promo.discount_scope == 'product' and promo.item_image %}
                            {% set full_image_path = promo.item_image %}
                        
                        {# 3. Category Logic: DB stores filename like 'cookie.jpg' or NULL #}
                        {% elseif promo.discount_scope == 'category' %}
                            {% if promo.item_image %}
                                {% set full_image_path = '/Assets/Categories/' ~ promo.item_image %}
                            {% else %}
                                {# Fallback to slug.png #}
                                {% set full_image_path = '/Assets/Categories/' ~ promo.item_sku ~ '.png' %}
                            {% endif %}
                        {% endif %}
                        {# ------------------------------- #}

                        <div class="swiper-slide">
                            <div class="flex flex-col md:flex-row h-full w-full">
                                
                                {# --- LEFT SIDE: TEXT CONTENT --- #}
                                <div class="w-full md:w-1/2 bg-[#755139] text-white p-8 md:p-12 relative flex flex-col justify-center items-start h-full">
                                    <div class="relative z-10 flex flex-col items-start gap-y-2">
                                        <h2 class="font-zen-antique text-3xl md:text-5xl tracking-wide uppercase shadow-sm drop-shadow-md leading-tight line-clamp-2">
                                            {{ promo.item_name }}
                                        </h2>
                                        <h3 class="font-zen-antique text-2xl md:text-3xl tracking-wide uppercase mb-2 text-[#D9CAB3]">
                                            Special Offer
                                        </h3>
                                        <p class="font-zen-antique text-lg md:text-xl text-[#E8DCC4] mb-8 uppercase tracking-wider border-l-4 border-[#D9CAB3] pl-4">
                                            | {% if promo.discount_type == 'percent' %}
                                                {{ promo.discount_value | number_format(0) }}% OFF
                                            {% else %}
                                                ₱{{ promo.discount_value | number_format(2) }} OFF
                                            {% endif %}
                                        </p>
                                        <a href="{{ app_url }}/products" class="px-8 py-3 bg-[#D9CAB3] text-[#5C3A2A] font-bold rounded-full shadow-md hover:scale-105 transition-all uppercase text-sm tracking-wide">
                                            Order Now
                                        </a>
                                    </div>

                                    {# Decoration Image (Cat) #}
                                    <div class="absolute bottom-4 right-4 w-32 md:w-40 z-0 opacity-100 pointer-events-none">
                                        <img src="/Assets/pancake-cat-illustration.png" 
                                             alt="" 
                                             class="w-full h-auto object-contain drop-shadow-xl"
                                             onerror="this.style.display='none'"> 
                                    </div>
                                    
                                    {# Checkbox #}
                                    <div class="absolute bottom-6 left-8 z-10 flex items-center">
                                        <input type="checkbox" id="dontShowAgain" class="w-4 h-4 text-[#A96B44] border-white/50 bg-transparent rounded focus:ring-0 cursor-pointer">
                                        <label for="dontShowAgain" class="ml-2 block text-xs text-white/80 font-light tracking-wide cursor-pointer">Don't show again</label>
                                    </div>
                                </div>

                                {# --- RIGHT SIDE: PRODUCT IMAGE --- #}
                                <div class="w-full md:w-1/2 h-64 md:h-full bg-[#5C3A2A] relative overflow-hidden group">
                                     
                                     {# IMAGE TAG using fixed path #}
                                     <img src="{{ full_image_path }}" 
                                          alt="{{ promo.item_name }}" 
                                          class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                          onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';"> 
                                     
                                     <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent pointer-events-none"></div>
                                </div>
                                
                            </div> 
                        </div> 
                    {% endfor %}
                </div>
                <div class="swiper-pagination modal-pagination !bottom-2 !text-[#D9CAB3]"></div>
            </div>
        </div>
    </div>
{% endif %}

<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- Modal & Popup Logic ---
        const modal = document.getElementById('discountModal');
        const overlay = document.getElementById('modalOverlay');
        const closeButton = document.getElementById('closeModalBtn');
        const dontShowCheckbox = document.getElementById('dontShowAgain');
        
        const storageKey = 'hideDiscountPopupTimestamp';
        const twelveHoursInMs = 12 * 60 * 60 * 1000;
        
        let modalSwiperInstance = null; 

        const showModal = () => {
            if(modal && overlay) {
                modal.classList.remove('hidden');
                overlay.classList.remove('hidden');

                if (!modalSwiperInstance && document.querySelector('.modalDiscountSwiper')) {
                    modalSwiperInstance = new Swiper(".modalDiscountSwiper", {
                        slidesPerView: 1,
                        effect: 'fade', 
                        fadeEffect: { crossFade: true },
                        loop: {{ (active_discounts | length > 1) ? 'true' : 'false' }},
                        autoplay: {
                            delay: 3500,
                            disableOnInteraction: false,
                        },
                        pagination: {
                            el: ".modal-pagination",
                            clickable: true,
                            dynamicBullets: true, 
                        },
                    });
                }
            }
        };

        const hideModal = () => {
            if(modal && overlay) {
                modal.classList.add('hidden');
                overlay.classList.add('hidden');
            }
            
            if (modalSwiperInstance && modalSwiperInstance.autoplay) {
                modalSwiperInstance.autoplay.stop();
            }

            if (dontShowCheckbox && dontShowCheckbox.checked) {
                const hideUntil = Date.now() + twelveHoursInMs;
                localStorage.setItem(storageKey, hideUntil.toString());
            }
        };

        // Check if we should show the modal on page load
        const hideUntilTimestamp = localStorage.getItem(storageKey);
        
        if (modal && (!hideUntilTimestamp || Date.now() > parseInt(hideUntilTimestamp, 10))) {
            setTimeout(showModal, 500); 
        }

        if(closeButton) closeButton.addEventListener('click', hideModal);
        if(overlay) overlay.addEventListener('click', hideModal);

        
        // --- Initialize MAIN PAGE Carousel (Existing) ---
        new Swiper(".discountSwiper", {
            slidesPerView: 1,
            spaceBetween: 10,
            pagination: {
                el: ".swiper-pagination",
                clickable: true,
            },
            breakpoints: {
                640: { slidesPerView: 2, spaceBetween: 20 },
                1024: { slidesPerView: 4, spaceBetween: 30 },
            },
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
            },
            loop: {{ (active_discounts | length > 4) ? 'true' : 'false' }}
        });
    });
</script>

{% endblock %}