{% extends "Layouts/public.twig" %}

{% block content %}

{% if product %}

<div class="snap-start pt-[6.5rem] md:pt-[7rem] min-h-screen">

    {# --- BREADCRUMB (Unchanged) --- #}
    <div class="max-w-4xl mx-auto px-6 mb-4">
      <div class="flex items-center gap-x-2 text-sm text-[#A69273] font-semibold">
        <a href="/products" class="hover:text-[#A96B44] hover:underline">All Products</a>
        {% if product.category and product.category.parent %}
          <span>/</span>
          <a href="/products?category={{ product.category.parent.slug }}" class="hover:text-[#A96B44] hover:underline">
            {{ product.category.parent.name }}
          </a>
        {% endif %}
        {% if product.category %}
          <span>/</span>
          <a href="/products?category={{ product.category.slug }}" class="hover:text-[#A96B44] hover:underline">
            {{ product.category.name }}
          </a>
        {% elseif product.category_name %}
          <span>/</span>
          <span class="text-gray-500">{{ product.category_name }}</span>
        {% endif %}
        <span>/</span>
        <span class="text-[#A96B44] truncate max-w-xs cursor-default">{{ product.name }}</span>
      </div>
    </div>
    {# --- END: BREADCRUMB --- #}


{% set productMargin = related_products is defined and related_products|length > 0 ? 'mb-6 md:mb-10' : 'mb-16 md:mb-20' %}

{# --- MODIFIED: Added new data attributes --- #}
<div class="max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-lg border border-pink-100 {{ productMargin }}"
     data-product-id="{{ product.id }}"
     data-product-sku="{{ product.sku }}"
     data-product-name="{{ product.name }}"
     data-product-price="{{ product.price }}" {# This is now the FINAL (discounted) price #}
     data-product-original-price="{{ product.original_price }}"
     data-product-discount-type="{{ product.discount_type }}"
     data-product-discount-value="{{ product.discount_value }}"
     data-product-image="{{ product.image }}"
     data-product-stock="{{ product.stock }}"
     data-product-sizes='{{ product.sizes|json_encode|raw }}'> {# This now contains discount info per size #}

      <div class="flex flex-col md:flex-row gap-8">
        <div class="md:w-1/2 flex justify-center">
          <div class="w-full max-w-sm h-96 bg-white rounded-xl shadow-md shadow-gray-400 flex items-center justify-center overflow-hidden">
            <img src="{{ product.image }}" alt="{{ product.name }}"
                 id="mainProductImage"
                 class="object-contain w-full h-full"
                 onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';">
          </div>
        </div>


        <div class="md:w-1/2 flex flex-col ">
          <div>
            <h1 class="text-3xl font-bold text-[#835234] mb-2">{{ product.name }}</h1>
            
            <p class="text-sm text-pink-600 font-semibold mb-2">{{ product.category.name | default(product.category_name) }}</p>
            
            {# --- MODIFIED: Price Display Block --- #}
            <div id="productPriceDisplay" class="mb-4">
                {% if product.discount_amount > 0 %}
                    <p class="text-2xl font-bold text-red-600">
                        {% if product.sizes|length > 0 %}Starts at {% endif %}
                        ₱{{ product.price|number_format(2) }}
                    </p>
                    <p class="text-lg text-gray-500 line-through">
                        ₱{{ product.original_price|number_format(2) }}
                    </p>
                {% else %}
                    <p class="text-2xl font-bold text-gray-700">
                        {% if product.sizes|length > 0 %}Starts at {% endif %}
                        ₱{{ product.price|number_format(2) }}
                    </p>
                {% endif %}
            </div>
            {# --- END MODIFIED: Price Display Block --- #}
            
            <p class="text-gray-700 mb-6 leading-relaxed">{{ product.description }}</p>

            {% if product.sizes is defined and product.sizes|length > 0 %}
              <div class="mb-4">
                <p class="font-semibold text-[#835234] mb-1">Available Sizes:</p>
                <div id="sizeSelector" class="flex gap-2 flex-wrap">
                  {% for size in product.sizes %}
                    {# --- MODIFIED: Added new data attributes for size --- #}
                    <button 
                      type="button"
                      data-size="{{ size.name }}"
                      data-stock="{{ size.stock }}"
                      data-price="{{ size.price }}"
                      data-original-price="{{ size.original_price }}"
                      data-discount-type="{{ size.discount_type }}"
                      data-discount-value="{{ size.discount_value }}"
                      data-image="{{ size.image | default('') }}"
                      class="size-btn px-3 py-1 bg-pink-100 text-pink-700 rounded-lg text-sm hover:bg-pink-200 focus:outline-none transition">
                      
                      {{ size.name }}
                      
                      {# --- MODIFIED: Show discounted price for size --- #}
                      {% if size.discount_amount > 0 %}
                        <span class="font-bold ">₱{{ size.price|number_format(2) }}</span>
                      {% else %}
                        <span>(₱{{ size.price|number_format(2) }})</span>
                      {% endif %}
                      - {{ size.stock }} left
                    </button>
                  {% endfor %}
                </div>
                <div id="sizeWarning" class="hidden flex items-center gap-2 mt-1 text-red-500 text-xs">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert shrink-0"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                  <p>Please select a size before adding to cart.</p>
                </div>
              </div>
            {% endif %}
            
            {% if product.sizes is empty %}
                <p class="text-sm text-gray-500 mt-4">Total Stock: {{ product.stock }}</p>
            {% endif %}
          </div>

          <div class="mt-6 flex flex-col gap-3">
            
            <div id="quantitySelectorContainer" 
                 class="flex items-center gap-3 {% if product.sizes is defined and product.sizes|length > 0 %}hidden{% endif %}">
              <label class="text-[#835234] font-semibold">Quantity:</label>
              <div class="flex items-center border rounded-lg overflow-hidden">
                <button id="decreaseQty" class="px-3 py-1 bg-pink-100 hover:bg-pink-200">−</button>
                <input id="quantityInput" type="number" value="1" min="1" max="{{ product.stock }}"
                       class="w-16 text-center border-l border-r outline-none">
                <button id="increaseQty" class="px-3 py-1 bg-pink-100 hover:bg-pink-200">+</button>
              </div>
            </div>

            <div class="flex gap-3">
              <button id="addToCartBtn" 
                      class="flex-1 bg-[#835234] hover:bg-[#6d412a] text-white py-2 rounded-xl transition">
                Add to Cart
              </button>
              <button id="addToFavouriteBtn" 
                      class="bg-pink-100 hover:bg-pink-200 text-[#835234] p-2 rounded-xl transition relative">
                <svg id="heartIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart transition-all duration-300"><path d="M19.5 12.571 12 20l-7.5-7.429A5 5 0 0 1 12 6a5 5 0 0 1 7.5 6.571Z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>

    {# --- MODIFIED: Related Products Loop --- #}
    {% if related_products is defined and related_products|length > 0 %}
      <div class="max-w-5xl mx-auto px-6 mt-10 mb-16">
        <h2 class="text-2xl font-bold text-[#835234] mb-6 text-center">
          Frequently Bought Together
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
          {% for related in related_products %}
            <a href="/products/{{ related.slug | default(related.sku) }}" 
               class="bg-white rounded-xl shadow-md hover:shadow-lg transition p-4 border border-pink-100 flex flex-col">
              
              <img src="{{ related.image | default('/Assets/placeholder-item.png') }}"
                   alt="{{ related.name }}"
                   class="w-full h-40 object-cover rounded-md mb-3">
              
              <h3 class="text-lg font-semibold text-[#835234] truncate">{{ related.name }}</h3>
              <p class="text-gray-600 text-sm mb-2">{{ related.category_name | default('') }}</p>
              
              {# --- MODIFIED: Price block for related items --- #}
              <div class="mt-auto">
                  {% if related.discount_amount > 0 %}
                      <p class="text-red-700 font-bold">₱{{ related.price|number_format(2) }}</p>
                      <p class="text-gray-500 text-sm line-through">₱{{ related.original_price|number_format(2) }}</p>
                  {% else %}
                      <p class="text-pink-700 font-bold">₱{{ related.price|number_format(2) }}</p>
                  {% endif %}
              </div>
              {# --- END MODIFIED --- #}
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    {# --- END MODIFIED: Related Products Loop --- #}

  </div>

  <style>
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
  }
  .shake {
    animation: shake 0.3s ease-in-out;
  }
  </style>

<script>
window.addEventListener("servicesReady", () => {
  const container = document.querySelector("[data-product-id]");
  if (!container) return;

  // --- Base elements (Unchanged) ---
  const qtyInput = document.getElementById("quantityInput");
  const decBtn = document.getElementById("decreaseQty");
  const incBtn = document.getElementById("increaseQty");
  const sizeButtons = Array.from(document.querySelectorAll("[data-size]"));
  const sizeWarning = document.getElementById("sizeWarning");
  const sizeSelector = document.getElementById("sizeSelector");
  const addToCartBtn = document.getElementById("addToCartBtn");
  const quantitySelectorContainer = document.getElementById("quantitySelectorContainer");
  const addToFavouriteBtn = document.getElementById("addToFavouriteBtn");
  const heartIcon = document.getElementById("heartIcon");
  const priceDisplay = document.getElementById("productPriceDisplay");
  const mainProductImage = document.getElementById("mainProductImage");

// --- MODIFIED: Product object now includes discount info ---
const product = {
  sku: container.dataset.productSku,
  name: container.dataset.productName,
  price: Number(container.dataset.productPrice),
  original_price: Number(container.dataset.productOriginalPrice),
  discount_type: container.dataset.productDiscountType,
  discount_value: Number(container.dataset.productDiscountValue),
  image: container.dataset.productImage,
  stock: Number(container.dataset.productStock || "1"),
  sizes: JSON.parse(container.dataset.productSizes || "[]"),
};

  // --- MODIFIED: 'selected' variables now track discount info ---
  let selectedSize = null;
  let selectedStock = 0;
  let selectedPrice = product.price;
  let selectedOriginalPrice = product.original_price;
  let selectedDiscountType = product.discount_type;
  let selectedDiscountValue = product.discount_value;
  let selectedImage = product.image;

  // --- (Favourite logic is unchanged) ---
  const updateHeartUI = () => {
    if (window.favouriteService && window.favouriteService.isFavourite(product.sku)) {
        heartIcon.classList.add("fill-red-500", "stroke-red-500");
    } else {
        heartIcon.classList.remove("fill-red-500", "stroke-red-500");
    }
  };
  
  const getAvailableStockForSelectedSize = () => {
    if (product.sizes.length > 0) {
      return selectedSize ? selectedStock : 0;
    }
    return product.stock;
  };

  const refreshQuantityUI = () => {
    if (product.sizes.length > 0) {
        if (!selectedSize) {
          addToCartBtn.classList.add("opacity-60", "cursor-not-allowed");
          addToCartBtn.dataset.disabled = "true";
          qtyInput.value = 1;
          decBtn.disabled = true;
          incBtn.disabled = true;
          
          // --- MODIFIED: Reset price display to show base discount ---
          if (priceDisplay) {
              const startsAt = product.sizes.length > 0 ? 'Starts at ' : '';
              if (product.original_price > product.price) {
                  priceDisplay.innerHTML = `
                      <p class="text-2xl font-bold text-red-600">${startsAt}₱${product.price.toFixed(2)}</p>
                      <p class="text-lg text-gray-500 line-through">₱${product.original_price.toFixed(2)}</p>
                  `;
              } else {
                  priceDisplay.innerHTML = `
                      <p class="text-2xl font-bold text-gray-700">${startsAt}₱${product.price.toFixed(2)}</p>
                  `;
              }
          }
          
          if (mainProductImage) {
              mainProductImage.src = product.image;
          }
          selectedImage = product.image;
          return;
        }
    }
    
    const available = getAvailableStockForSelectedSize();

    addToCartBtn.classList.remove("opacity-60", "cursor-not-allowed");
    addToCartBtn.dataset.disabled = "false";
    
    if (available <= 0) {
      addToCartBtn.classList.add("opacity-60", "cursor-not-allowed");
      addToCartBtn.dataset.disabled = "true";
      addToCartBtn.textContent = "Out of Stock";
    } else {
      addToCartBtn.classList.remove("opacity-60", "cursor-not-allowed");
      addToCartBtn.dataset.disabled = "false";
      addToCartBtn.textContent = "Add to Cart";
    }

    decBtn.disabled = Number(qtyInput.value) <= 1;
    incBtn.disabled = Number(qtyInput.value) >= available;
    qtyInput.max = available;
  };

  // --- Size selection ---
  sizeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      sizeButtons.forEach(b => b.classList.remove("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]"));
      sizeButtons.forEach(b => b.classList.add("bg-pink-100", "text-pink-700"));

      btn.classList.remove("bg-pink-100", "text-pink-700");
      btn.classList.add("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]");

      // --- MODIFIED: Get all discount info from the selected size ---
      selectedSize = btn.dataset.size;
      selectedStock = Number(btn.dataset.stock);
      selectedPrice = Number(btn.dataset.price);
      selectedOriginalPrice = Number(btn.dataset.originalPrice);
      selectedDiscountType = btn.dataset.discountType;
      selectedDiscountValue = Number(btn.dataset.discountValue);
      
      // --- MODIFIED: Update price display with discount HTML ---
      if (priceDisplay) {
          if (selectedOriginalPrice > selectedPrice) {
              priceDisplay.innerHTML = `
                  <p class="text-2xl font-bold text-red-600">₱${selectedPrice.toFixed(2)}</p>
                  <p class="text-lg text-gray-500 line-through">₱${selectedOriginalPrice.toFixed(2)}</p>
              `;
          } else {
              priceDisplay.innerHTML = `
                  <p class="text-2xl font-bold text-gray-700">₱${selectedPrice.toFixed(2)}</p>
              `;
          }
      }
      
      const newImage = btn.dataset.image;
      if (newImage && mainProductImage) {
          mainProductImage.src = newImage;
          selectedImage = newImage;
      } else if (mainProductImage) {
          mainProductImage.src = product.image;
          selectedImage = product.image;
      }
      
      if (quantitySelectorContainer) {
        quantitySelectorContainer.classList.remove("hidden");
      }
      
      sizeWarning.classList.add("hidden");
      qtyInput.value = 1;
      refreshQuantityUI();
    });
  });

  if (product.sizes.length === 1) {
    sizeButtons[0].click();
  }
  
  // --- (Quantity buttons unchanged) ---
  decBtn.addEventListener("click", () => {
      let currentVal = Number(qtyInput.value);
      if (currentVal > 1) {
          qtyInput.value = currentVal - 1;
          refreshQuantityUI();
      }
  });

  incBtn.addEventListener("click", () => {
      let currentVal = Number(qtyInput.value);
      const max = Number(qtyInput.max || 1);
      if (currentVal < max) {
          qtyInput.value = currentVal + 1;
          refreshQuantityUI();
      }
  });
  
  qtyInput.addEventListener("change", () => {
      let currentVal = Number(qtyInput.value);
      const max = Number(qtyInput.max || 1);
      if (currentVal < 1) qtyInput.value = 1;
      if (currentVal > max) qtyInput.value = max;
      refreshQuantityUI();
  });

  // --- Add to Cart ---
  addToCartBtn.addEventListener("click", () => {
    if (product.sizes.length > 0 && !selectedSize) {
      sizeWarning.classList.remove("hidden");
      sizeSelector.classList.add("shake");
      setTimeout(() => sizeSelector.classList.remove("shake"), 300);
      return;
    }

    const availableStock = getAvailableStockForSelectedSize();
    if (availableStock <= 0) {
      window.showModal({
        type: "warning",
        title: "Out of Stock",
        message: `Sorry, ${product.name}${selectedSize ? " (" + selectedSize + ")" : ""} is out of stock.`,
        buttons: [{ text: "OK", variant: "cancel" }],
      });
      return;
    }
    
    const requested = Math.min(Number(qtyInput.value) || 1, availableStock);

    // --- MODIFIED: Pass all discount info to cartService ---
    window.cartService.addItem({
        sku: product.sku,
        name: product.name,
        image: selectedImage, 
        price: selectedPrice, // Final discounted price
        original_price: selectedOriginalPrice,
        discount_type: selectedDiscountType,
        discount_value: selectedDiscountValue,
        selectedSize,
        stock: selectedSize ? selectedStock : product.stock,
    }, requested);

    window.showModal({
        type: "success",
        title: "Added to Cart",
        message: `${product.name}${selectedSize ? " (" + selectedSize + ")" : ""} × ${requested} added successfully.`,
        buttons: [{ text: "OK", variant: "confirm" }],
    });

    // --- MODIFIED: Reset UI now includes discount vars ---
    qtyInput.value = 1;
    if (product.sizes.length > 0) {
        selectedSize = null;
        selectedStock = 0;
        selectedPrice = product.price; 
        selectedOriginalPrice = product.original_price;
        selectedDiscountType = product.discount_type;
        selectedDiscountValue = product.discount_value;
        selectedImage = product.image; 

        if (mainProductImage) {
          mainProductImage.src = product.image;
        }
        sizeButtons.forEach(b => {
          b.classList.remove("bg-[#835234]", "text-white", "ring-2", "ring-[#835234]");
          b.classList.add("bg-pink-100", "text-pink-700");
        });
        
        if (quantitySelectorContainer) {
          quantitySelectorContainer.classList.add("hidden");
        }
    }
    refreshQuantityUI();
  });

  // --- (Favourite logic unchanged) ---
  addToFavouriteBtn.addEventListener("click", () => {
    if (!window.favouriteService) return;
    const wasAdded = window.favouriteService.toggle(product);
    updateHeartUI();
    window.showModal({
      type: wasAdded ? "success" : "info",
      title: wasAdded ? "Added to Favourites" : "Removed from Favourites",
      message: `${product.name} ${wasAdded ? "added to" : "removed from"} your favourites.`,
      buttons: [{ text: "OK", variant: "confirm" }],
      duration: 3000
    });
  });

  window.addEventListener("favouritesChanged", updateHeartUI);
  window.addEventListener("cartChanged", refreshQuantityUI);
  window.addEventListener("storage", () => {
    refreshQuantityUI();
    updateHeartUI();
  });

  // --- Initial Load ---
  refreshQuantityUI();
  updateHeartUI();
});
</script>
  {# End of existing code for a found product #}


{% else %}

  {# --- Error block (Unchanged) --- #}
  <div class="snap-start pt-20 ">
    <div class="max-w-4xl mx-auto p-6 py-20 bg-white rounded-2xl shadow-lg border border-pink-100 text-center">
        
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search-slash mx-auto text-pink-400 mb-4">
            <path d="m14 14-4.5 4.5"/>
            <path d="M10.5 10.5 6 6"/>
            <path d="m21 21-4.5-4.5"/>
            <path d="m17 17-4.5-4.5"/>
            <circle cx="11" cy="11" r="8"/>
        </svg>

        <h1 class="text-3xl font-bold text-[#835234] mb-4">Product Not Found</h1>
        <p class="text-gray-700 mb-8 text-lg">
            {{ error_message|default("Sorry, we couldn't find that product. It might have been unlisted, edited, or removed.") }}
        </p>
        <a href="/products" 
           class="bg-[#835234] hover:bg-[#6d412a] text-white py-2 px-6 rounded-xl transition font-semibold text-lg">
            Back to All Products
        </a>
    </div>
  </div>
  {# --- END: Error block --- #}

{% endif %}
{# --- END: Error Handler Check --- #}

{% endblock %}