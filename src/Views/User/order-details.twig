{% set activePage = 'orders' %}

{% extends "Layouts/account.twig" %}

{% block content %}
<div class="max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-lg border border-pink-100">
 
 {# --- Header & Back Link --- #}
 <div class="flex items-center justify-between mb-8">
  <div>
   <h1 class="text-3xl font-bold text-[#835234]">Order #{{ order.id }}</h1>
   <p class="text-sm text-gray-500">Placed on {{ order.date|date("F j, Y, g:i a") }}</p>
  </div>
  <a href="/account/orders" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-xl transition text-sm">
   &larr; Back to All Orders
  </a>
 </div>

 {# --- Status & Shipping Info Grid --- #}
 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
  <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
   <h2 class="text-lg font-semibold text-[#a07445] mb-3">Order Status</h2>
   <span class="text-lg font-bold
    {% if order.status == 'Delivered' %}text-green-600
    {% elseif order.status == 'Shipped' %}text-blue-600
    {% elseif order.status == 'Processing' %}text-yellow-600
    {% else %}text-gray-500
    {% endif %}
   ">{{ order.status }}</span>

   {% if order.status == 'Shipped' %}
    <form action="/account/orders/{{ order.id }}/confirm-delivery" method="POST" class="mt-4">
     <button type="submit" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition">
      Confirm Delivery
     </button>
     <p class="text-xs text-gray-500 mt-2">Click here to confirm you have received your items.</p>
    </form>
   {% endif %}
  </div>
  <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
   <h2 class="text-lg font-semibold text-[#a07445] mb-3">Shipping Address</h2>
   <div class="text-gray-700 not-italic">
    <p class="font-medium">{{ order.customer_name }}</p>
    <p>{{ order.address.street }}</p>
    <p>{{ order.address.city }}, {{ order.address.state }} {{ order.address.postal_code }}</p>
   </div>
  </div>
 </div>

 {# --- Items List --- #}
 <h2 class="text-2xl font-semibold text-[#a07445] mb-4">Items in this Order</h2>
 <div class="space-y-4 border-t border-b border-gray-200 py-4">
  
  {% for item in order.items %}
   <a href="{{ item.sku ? '/products/' ~ item.sku : '#' }}" 
    class="flex items-center gap-4 p-2 rounded-lg transition {{ item.sku ? 'hover:bg-pink-50' : 'cursor-default' }}">
    
    <!-- --- FIX: Added a fallback image and an onerror event --- -->
    <img src="{{ item.image | default('/Assets/placeholder-item.png') }}" 
         alt="{{ item.product_name }}" 
         class="w-20 h-20 rounded-lg object-cover border border-pink-100 bg-pink-50"
         onerror="this.onerror=null; this.src='/Assets/placeholder-item.png';">
    <!-- --- END FIX --- -->

    <div class="flex-1">
     <p class="text-lg font-semibold text-gray-800">{{ item.product_name }}</p>
     <p class="text-sm text-gray-500">{{ item.size }}</p>
     <p class="text-sm text-gray-500">Quantity: {{ item.quantity }}</p>
    </div>
    
    <div class="text-right">
     <p class="text-lg font-medium text-gray-900">₱{{ (item.price * item.quantity)|number_format(2) }}</p>
     <p class="text-sm text-gray-500">(₱{{ item.price|number_format(2) }} each)</p>
    </div>

   </a>
  {% endfor %}

 </div>

 {# --- Totals --- #}
 <div class="flex justify-end mt-6">
  <div class="w-full max-w-sm space-y-2">
   
   <div class="flex justify-between text-gray-700">
    <span>Subtotal</span>
    <span class="font-medium">₱{{ order.subtotal|number_format(2) }}</span>
   </div>
   <div class="flex justify-between text-gray-700">
    <span>Tax</span>
    <span class="font-medium">₱{{ order.tax|number_format(2) }}</span>
   </div>
   <div class="flex justify-between text-gray-700">
    <span>Shipping</span>
    <span class="font-medium">₱{{ order.shipping_fee|number_format(2) }}</span>
   </div>
   <div class="flex justify-between text-xl font-bold text-[#835234] mt-2 pt-2 border-t border-pink-300">
    <span>Total Paid</span>
    <span>₱{{ (order.total)|number_format(2) }}</span>
   </div>
  </div>
 </div>

</div>
{% endblock %}